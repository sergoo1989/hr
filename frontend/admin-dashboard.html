<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="analytics-functions.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: #f8f9fa;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .approve-btn {
            background: #28a745;
            color: white;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Analytics Styles */
        .analytics-section {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .analytics-table thead {
            background: #f8f9fa;
        }

        .analytics-table th {
            padding: 12px;
            text-align: right;
            color: #555;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .analytics-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            color: #333;
        }

        .analytics-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-danger {
            background: #ff5252;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-success {
            background: #4caf50;
            color: white;
        }

        .badge-info {
            background: #2196f3;
            color: white;
        }
        
        /* Table styles for better display */
        #employeesList table {
            font-size: 12px;
            width: 100%;
            overflow-x: auto;
            display: block;
        }
        
        #employeesList table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        #employeesList table th {
            white-space: nowrap;
            padding: 10px 8px;
            font-size: 11px;
        }
        
        #employeesList table td {
            white-space: nowrap;
            padding: 8px 6px;
            font-size: 11px;
        }
    </style>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amiri-font@1.0.3/dist/amiri.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            <div class="user-info">
                <span id="username"></span>
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', event)">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
            <button class="tab" onclick="switchTab('analytics', event)">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
            <a href="payroll-report.html" class="tab" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">ğŸ’° Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</a>
            <a href="assets.html" class="tab" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">ğŸ“¦ Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ø¹ÙŠÙ†ÙŠØ©</a>
            <button class="tab" onclick="switchTab('addEmployee', event)">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
            <button class="tab" onclick="switchTab('employees', event)">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
            <button class="tab" onclick="switchTab('leaves', event)">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</button>
            <button class="tab" onclick="switchTab('advances', event)">Ø§Ù„Ø³Ù„Ù</button>
            <button class="tab" onclick="switchTab('settings', event)">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">-</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingLeaves">-</div>
                    <div class="stat-label">Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingAdvancesCount">-</div>
                    <div class="stat-label">Ø³Ù„Ù Ù…Ø¹Ù„Ù‚Ø©</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    <div class="stat-value" id="expiringDocuments" style="color: white;">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ÙˆØ«Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
                </div>
            </div>
        </div>

        <!-- Add Employee Tab -->
        <div id="addEmployee" class="tab-content">
            <div class="section">
                <h2>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h2>
                <div id="addEmployeeAlert" class="alert"></div>
                <form id="addEmployeeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="employeeNumber">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                            <input type="text" id="employeeNumber" readonly style="background: #f0f0f0; cursor: not-allowed;" placeholder="Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="form-group">
                            <label for="nationalId">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© *</label>
                            <input type="text" id="nationalId" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="email">
                        </div>
                        <div class="form-group">
                            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                            <input type="tel" id="phone">
                        </div>
                        <div class="form-group">
                            <label for="department">Ø§Ù„Ù‚Ø³Ù… *</label>
                            <select id="department" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="jobTitle">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                            <select id="jobTitle" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hireDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† *</label>
                            <input type="date" id="hireDate" required>
                        </div>
                        <div class="form-group">
                            <label for="basicSalary">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ *</label>
                            <input type="number" id="basicSalary" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="housingAllowance">Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†</label>
                            <input type="number" id="housingAllowance" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="transportAllowance">Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„</label>
                            <input type="number" id="transportAllowance" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="nationality">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label>
                            <select id="nationality" onchange="toggleNonSaudiFields()">
                                <option value="SAUDI">Ø³Ø¹ÙˆØ¯ÙŠ</option>
                                <option value="NON_SAUDI">ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</label>
                            <select id="workType">
                                <option value="FULL_TIME">Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„</option>
                                <option value="PART_TIME">Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ (Part-Time)</option>
                                <option value="REMOTE">Ø¹Ù† Ø¨Ø¹Ø¯</option>
                                <option value="CONTRACT">Ø¹Ù‚Ø¯ Ù…Ø¤Ù‚Øª</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contractDuration">Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ (Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±)</label>
                            <input type="number" id="contractDuration" min="1">
                        </div>
                        <div class="form-group">
                            <label for="contractLeaveDays">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯</label>
                            <input type="number" id="contractLeaveDays" min="0">
                        </div>
                        <div class="form-group">
                            <label for="contractEndDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</label>
                            <input type="date" id="contractEndDate">
                        </div>
                        <div class="form-group">
                            <label for="medicalInsuranceExpiryDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ</label>
                            <input type="date" id="medicalInsuranceExpiryDate">
                        </div>
                    </div>
                    
                    <!-- Non-Saudi Employee Additional Fields -->
                    <div id="nonSaudiFields" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #007bff;">
                        <h3 style="color: #007bff; margin-bottom: 15px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="sponsorshipType">Ù†ÙˆØ¹ Ø§Ù„ÙƒÙØ§Ù„Ø© *</label>
                                <select id="sponsorshipType">
                                    <option value="COMPANY">ÙƒÙØ§Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ©</option>
                                    <option value="PERSONAL">ÙƒÙØ§Ù„Ø© Ø´Ø®ØµÙŠØ©</option>
                                    <option value="EXTERNAL">Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ticketEntitlement">Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø© *</label>
                                <select id="ticketEntitlement">
                                    <option value="false">Ù„Ø§</option>
                                    <option value="true">Ù†Ø¹Ù…</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ticketClass">Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© *</label>
                                <select id="ticketClass">
                                    <option value="ECONOMY">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option>
                                    <option value="BUSINESS">Ø¯Ø±Ø¬Ø© Ø£Ø¹Ù…Ø§Ù„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="passportNumber">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²</label>
                                <input type="text" id="passportNumber">
                            </div>
                            <div class="form-group">
                                <label for="passportExpiryDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²</label>
                                <input type="date" id="passportExpiryDate">
                            </div>
                            <div class="form-group">
                                <label for="workPermitExpiryDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø®ØµØ© Ø§Ù„Ø¹Ù…Ù„</label>
                                <input type="date" id="workPermitExpiryDate">
                            </div>
                            <div class="form-group">
                                <label for="passportFeesExpiryDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬ÙˆØ§Ø²Ø§Øª</label>
                                <input type="date" id="passportFeesExpiryDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- End of Service Section -->
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 15px;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                        <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø³Ø¨ Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="terminationReason">Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                                <select id="terminationReason">
                                    <option value="">-- Ù„Ù… ÙŠÙ†ØªÙ‡Ù Ø¨Ø¹Ø¯ --</option>
                                    <option value="NORMAL_END">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¹Ù‚Ø¯</option>
                                    <option value="RESIGNATION">Ø§Ø³ØªÙ‚Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù</option>
                                    <option value="TERMINATION">Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="terminationDate">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                                <input type="date" id="terminationDate">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù</button>
                </form>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="employees" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportToExcel()" class="btn" style="background: #28a745; padding: 10px 20px;">
                            ğŸ“Š ØªØµØ¯ÙŠØ± Excel
                        </button>
                        <button onclick="exportToPDF()" class="btn" style="background: #dc3545; padding: 10px 20px;">
                            ğŸ“„ ØªØµØ¯ÙŠØ± PDF
                        </button>
                    </div>
                </div>
                <div id="employeesList"></div>
            </div>
        </div>

        <!-- Leaves Tab -->
        <div id="leaves" class="tab-content">
            <div class="section">
                <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
                <div id="leavesList"></div>
            </div>
        </div>

        <!-- Advances Tab -->
        <div id="advances" class="tab-content">
            <div class="section">
                <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
                <div id="advancesList"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div id="analyticsLoading" style="text-align: center; padding: 50px; color: #667eea; font-size: 20px;">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª...
            </div>
            
            <div id="analyticsContent" style="display: none;">
                <!-- Statistics Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;" id="analyticsStatsGrid"></div>

                <!-- Navigation Sub-Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="btn" style="background: #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('overview')">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('leaveBalances')">Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('endOfService')">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('assetsAnalysis')">Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ø¹ÙŠÙ†ÙŠØ©</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('ticketsAnalysis')">Ø§Ù„ØªØ°Ø§ÙƒØ±</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('documentsAlerts')">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
                </div>

                <!-- Overview Section - Charts -->
                <div id="analyticsOverview" class="analytics-section" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h3>
                            <canvas id="departmentChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</h3>
                            <canvas id="nationalityChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h3>
                            <canvas id="leaveTypeChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
                            <canvas id="salaryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Leave Balances Section -->
                <div id="analyticsLeaveBalances" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
                        <div id="leaveBalancesTable"></div>
                    </div>
                </div>

                <!-- End of Service Section -->
                <div id="analyticsEndOfService" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§ÙØ£Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©</h2>
                        <div id="endOfServiceTable"></div>
                    </div>
                </div>

                <!-- Assets Analysis Section -->
                <div id="analyticsAssetsAnalysis" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ğŸ“¦ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ø¹ÙŠÙ†ÙŠØ©</h2>
                        <div id="assetsAnalysisTable"></div>
                    </div>
                </div>

                <!-- Tickets Section -->
                <div id="analyticsTicketsAnalysis" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ† Ù„Ù„ØªØ°Ø§ÙƒØ±</h2>
                        <div id="ticketsAnalysisTable"></div>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div id="analyticsDocumentsAlerts" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</h2>
                        <div id="documentsAlertsTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h2>
                <form id="companySettingsForm">
                    <!-- Logo Upload Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">ğŸ¢</span>
                            Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©
                        </h3>
                        <div style="display: flex; gap: 25px; align-items: start;">
                            <!-- Logo Preview -->
                            <div style="flex-shrink: 0;">
                                <div id="logoPreview" style="width: 150px; height: 150px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                                    <img id="logoImage" src="" style="max-width: 100%; max-height: 100%; display: none; object-fit: contain;">
                                    <span id="logoPlaceholder" style="color: #ccc; font-size: 14px; text-align: center; padding: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø±</span>
                                </div>
                            </div>
                            <!-- Logo Upload Controls -->
                            <div style="flex: 1;">
                                <p style="color: rgba(255,255,255,0.95); margin-bottom: 15px; line-height: 1.6;">
                                    Ù‚Ù… Ø¨Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø´Ø±ÙƒØªÙƒ Ø¨ØµÙŠØºØ© PNG Ø£Ùˆ JPG. Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©.
                                </p>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <input type="file" id="logoUpload" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="handleLogoUpload(event)">
                                    <button type="button" onclick="document.getElementById('logoUpload').click()" class="btn" style="background: white; color: #667eea; padding: 10px 20px; font-weight: 600;">
                                        ğŸ“¤ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø§Ø±
                                    </button>
                                    <button type="button" onclick="removeLogo()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; backdrop-filter: blur(10px);">
                                        ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±
                                    </button>
                                </div>
                                <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 10px;">
                                    Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: 500x500 Ø¨ÙƒØ³Ù„ | Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="companyName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¹Ø±Ø¨ÙŠ) *</label>
                            <input type="text" id="companyName" required>
                        </div>
                        <div class="form-group">
                            <label for="companyNameEn">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (English)</label>
                            <input type="text" id="companyNameEn">
                        </div>
                        <div class="form-group">
                            <label for="companyEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="companyEmail">
                        </div>
                        <div class="form-group">
                            <label for="companyPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label for="companyAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <input type="text" id="companyAddress">
                        </div>
                        <div class="form-group">
                            <label for="taxNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
                            <input type="text" id="taxNumber">
                        </div>
                    </div>
                    <button type="submit" class="btn">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
                </form>
            </div>

            <div class="section" style="margin-top: 30px;">
                <h2>Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                    <!-- Departments -->
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="newDepartment" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex: 1;">
                            <button onclick="addDepartment()" class="btn" style="padding: 10px 20px;">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div id="departmentsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <!-- Job Titles -->
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="newJobTitle" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex: 1;">
                            <button onclick="addJobTitle()" class="btn" style="padding: 10px 20px;">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div id="jobTitlesList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (!token) {
            window.location.href = 'login.html';
        }

        document.getElementById('username').textContent = username;

        function switchTab(tabName, event = null) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find and activate the tab button by onclick attribute
                const tabButton = Array.from(document.querySelectorAll('.tab')).find(
                    tab => tab.getAttribute('onclick')?.includes(`'${tabName}'`)
                );
                if (tabButton) tabButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'employees') loadEmployees();
            if (tabName === 'leaves') loadPendingLeaves();
            if (tabName === 'advances') loadPendingAdvances();
            if (tabName === 'settings') loadSettings();
            if (tabName === 'analytics') loadAnalytics();
        }

        async function loadDashboard() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await response.json();
                
                document.getElementById('totalEmployees').textContent = stats.totalEmployees || 0;
                document.getElementById('pendingLeaves').textContent = stats.pendingLeaves || 0;
                document.getElementById('pendingAdvancesCount').textContent = stats.pendingAdvances || 0;
                
                // Calculate expiring documents for non-Saudi employees
                const employeesResponse = await fetch(`${apiUrl}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employees = await employeesResponse.json();
                
                const today = new Date();
                let expiringCount = 0;
                
                employees.forEach(emp => {
                    if (emp.nationality === 'NON_SAUDI') {
                        const checkExpiry = (dateStr) => {
                            if (!dateStr) return false;
                            const days = Math.floor((new Date(dateStr) - today) / (1000 * 60 * 60 * 24));
                            return days <= 90; // Expiring within 90 days or already expired
                        };
                        
                        if (checkExpiry(emp.passportExpiryDate) || 
                            checkExpiry(emp.workPermitExpiryDate) || 
                            checkExpiry(emp.medicalInsuranceExpiryDate)) {
                            expiringCount++;
                        }
                    }
                });
                
                document.getElementById('expiringDocuments').textContent = expiringCount;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        let isLoadingEmployees = false;
        
        // Toggle Non-Saudi Fields
        function toggleNonSaudiFields() {
            const nationality = document.getElementById('nationality').value;
            const nonSaudiFields = document.getElementById('nonSaudiFields');
            
            if (nationality === 'NON_SAUDI') {
                nonSaudiFields.style.display = 'block';
            } else {
                nonSaudiFields.style.display = 'none';
                // Clear non-Saudi fields when switching to Saudi
                document.getElementById('contractDuration').value = '';
                document.getElementById('contractLeaveDays').value = '';
                document.getElementById('passportNumber').value = '';
                document.getElementById('passportExpiryDate').value = '';
                document.getElementById('workPermitExpiryDate').value = '';
                document.getElementById('passportFeesExpiryDate').value = '';
                document.getElementById('medicalInsuranceExpiryDate').value = '';
            }
        }
        
        async function loadEmployees() {
            if (isLoadingEmployees) {
                console.log('Already loading employees, skipping duplicate call...');
                return;
            }
            
            isLoadingEmployees = true;
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employees = await response.json();
                window.employeesData = employees; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
                
                const container = document.getElementById('employeesList');
                if (!employees || employees.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</p>';
                    return;
                }

                // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø©
                const nationalityNames = { 'SAUDI': 'Ø³Ø¹ÙˆØ¯ÙŠ', 'NON_SAUDI': 'ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ' };
                const workTypeNames = { 'FULL_TIME': 'Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„', 'PART_TIME': 'Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ', 'REMOTE': 'Ø¹Ù† Ø¨Ø¹Ø¯', 'CONTRACT': 'Ø¹Ù‚Ø¯ Ù…Ø¤Ù‚Øª' };
                const sponsorshipNames = { 'COMPANY': 'Ø§Ù„Ø´Ø±ÙƒØ©', 'PERSONAL': 'Ø´Ø®ØµÙŠØ©', 'EXTERNAL': 'Ø®Ø§Ø±Ø¬ÙŠØ©' };
                const ticketClassNames = { 'ECONOMY': 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©', 'BUSINESS': 'Ø£Ø¹Ù…Ø§Ù„' };
                const terminationReasonNames = { 'NORMAL_END': 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø·Ø¨ÙŠØ¹ÙŠ', 'RESIGNATION': 'Ø§Ø³ØªÙ‚Ø§Ù„Ø©', 'TERMINATION': 'Ø¥Ù†Ù‡Ø§Ø¡' };

                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th>Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</th>
                                    <th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                    <th>Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†</th>
                                    <th>Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„ÙƒÙØ§Ù„Ø©</th>
                                    <th>Ø§Ù„ØªØ°ÙƒØ±Ø©</th>
                                    <th>Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©</th>
                                    <th>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²</th>
                                    <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²</th>
                                    <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø®ØµØ© Ø§Ù„Ø¹Ù…Ù„</th>
                                    <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
                                    <th>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th>Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employees.map(emp => {
                                    let statusBadge = '';
                                    
                                    // Check for expiring documents for non-Saudi employees
                                    if (emp.nationality === 'NON_SAUDI') {
                                        const today = new Date();
                                        let warnings = [];
                                        
                                        if (emp.passportExpiryDate) {
                                            const days = Math.floor((new Date(emp.passportExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('Ø¬ÙˆØ§Ø² Ù…Ù†ØªÙ‡ÙŠ');
                                            else if (days <= 90) warnings.push(`Ø¬ÙˆØ§Ø² (${days}Ø¯)`);
                                        }
                                        
                                        if (emp.workPermitExpiryDate) {
                                            const days = Math.floor((new Date(emp.workPermitExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('Ø±Ø®ØµØ© Ù…Ù†ØªÙ‡ÙŠØ©');
                                            else if (days <= 90) warnings.push(`Ø±Ø®ØµØ© (${days}Ø¯)`);
                                        }
                                        
                                        if (emp.medicalInsuranceExpiryDate) {
                                            const days = Math.floor((new Date(emp.medicalInsuranceExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('ØªØ£Ù…ÙŠÙ† Ù…Ù†ØªÙ‡ÙŠ');
                                            else if (days <= 90) warnings.push(`ØªØ£Ù…ÙŠÙ† (${days}Ø¯)`);
                                        }
                                        
                                        if (warnings.length > 0) {
                                            statusBadge = `<span style="background: #ff5252; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; display: inline-block;">${warnings.join(', ')}</span>`;
                                        } else {
                                            statusBadge = `<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">âœ“ Ø³Ù„ÙŠÙ…</span>`;
                                        }
                                    } else {
                                        statusBadge = `<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">âœ“ Ø³Ø¹ÙˆØ¯ÙŠ</span>`;
                                    }
                                    
                                    const totalSalary = (parseFloat(emp.basicSalary) || 0) + (parseFloat(emp.housingAllowance) || 0) + (parseFloat(emp.transportAllowance) || 0);
                                    
                                    return `
                                    <tr>
                                        <td><strong>${emp.employeeNumber}</strong></td>
                                        <td><strong>${emp.fullName}</strong></td>
                                        <td>${emp.nationalId || '-'}</td>
                                        <td>${emp.email || '-'}</td>
                                        <td>${emp.phone || '-'}</td>
                                        <td>${emp.department || '-'}</td>
                                        <td>${emp.jobTitle || '-'}</td>
                                        <td>${emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.basicSalary || 0}</td>
                                        <td>${emp.housingAllowance || 0}</td>
                                        <td>${emp.transportAllowance || 0}</td>
                                        <td><strong>${totalSalary.toFixed(2)}</strong></td>
                                        <td>${nationalityNames[emp.nationality] || emp.nationality}</td>
                                        <td>${workTypeNames[emp.workType] || emp.workType || '-'}</td>
                                        <td>${sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '-'}</td>
                                        <td>${emp.ticketEntitlement ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
                                        <td>${ticketClassNames[emp.ticketClass] || emp.ticketClass || '-'}</td>
                                        <td>${emp.contractDuration || '-'}</td>
                                        <td>${emp.contractLeaveDays || '-'}</td>
                                        <td>${emp.passportNumber || '-'}</td>
                                        <td>${emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${terminationReasonNames[emp.terminationReason] || '-'}</td>
                                        <td>${emp.terminationDate ? new Date(emp.terminationDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${statusBadge}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                                                <button onclick="editEmployee(${emp.id})" style="background: #4CAF50; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">ØªØ¹Ø¯ÙŠÙ„</button>
                                                <button onclick="deleteEmployee(${emp.id}, '${emp.fullName}')" style="background: #f44336; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">Ø­Ø°Ù</button>
                                                ${emp.email ? `<button onclick="resendActivationEmail(${emp.id}, '${emp.fullName}')" style="background: #2196F3; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„">ğŸ“§ Ø¥Ø±Ø³Ø§Ù„</button>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading employees:', error);
            } finally {
                isLoadingEmployees = false;
            }
        }

        async function loadPendingLeaves() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/leaves/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const leaves = await response.json();
                
                const container = document.getElementById('leavesList');
                if (!leaves || leaves.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                                <th>Ù…Ù† ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${leaves.map(leave => {
                                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…
                                const start = new Date(leave.startDate);
                                const end = new Date(leave.endDate);
                                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                                
                                return `
                                <tr>
                                    <td>${leave.employee?.fullName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                    <td>${getLeaveTypeName(leave.type)}</td>
                                    <td>${start.toLocaleDateString('ar-SA')}</td>
                                    <td>${end.toLocaleDateString('ar-SA')}</td>
                                    <td>${days}</td>
                                    <td>
                                        <button class="action-btn approve-btn" onclick="approveLeave(${leave.id})">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                                        <button class="action-btn reject-btn" onclick="rejectLeave(${leave.id})">Ø±ÙØ¶</button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading leaves:', error);
            }
        }

        async function loadPendingAdvances() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/advances/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const advances = await response.json();
                
                const container = document.getElementById('advancesList');
                if (!advances || advances.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù Ù…Ø¹Ù„Ù‚Ø©</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${advances.map(advance => `
                                <tr>
                                    <td>${advance.employee?.fullName || '-'}</td>
                                    <td>${advance.amount} Ø±ÙŠØ§Ù„</td>
                                    <td>${new Date(advance.requestDate).toLocaleDateString('ar-SA')}</td>
                                    <td>${advance.reason || '-'}</td>
                                    <td>
                                        <button class="action-btn approve-btn" onclick="approveAdvance(${advance.id})">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                                        <button class="action-btn reject-btn" onclick="rejectAdvance(${advance.id})">Ø±ÙØ¶</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading advances:', error);
            }
        }

        // Add Employee Form Handler
        document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = document.getElementById('submitBtn');
            const alert = document.getElementById('addEmployeeAlert');
            submitBtn.disabled = true;
            
            const employeeData = {
                fullName: document.getElementById('fullName').value,
                nationalId: document.getElementById('nationalId').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                department: document.getElementById('department').value,
                jobTitle: document.getElementById('jobTitle').value,
                hireDate: document.getElementById('hireDate').value,
                basicSalary: parseFloat(document.getElementById('basicSalary').value),
                housingAllowance: parseFloat(document.getElementById('housingAllowance').value) || 0,
                transportAllowance: parseFloat(document.getElementById('transportAllowance').value) || 0,
                nationality: document.getElementById('nationality').value,
                workType: document.getElementById('workType').value,
                sponsorshipType: document.getElementById('sponsorshipType').value,
                ticketEntitlement: document.getElementById('ticketEntitlement').value === 'true',
                ticketClass: document.getElementById('ticketClass').value
            };
            
            // Add non-Saudi fields if applicable
            if (employeeData.nationality === 'NON_SAUDI') {
                const contractDuration = document.getElementById('contractDuration').value;
                const contractLeaveDays = document.getElementById('contractLeaveDays').value;
                const passportNumber = document.getElementById('passportNumber').value;
                const passportExpiryDate = document.getElementById('passportExpiryDate').value;
                const workPermitExpiryDate = document.getElementById('workPermitExpiryDate').value;
                const passportFeesExpiryDate = document.getElementById('passportFeesExpiryDate').value;
                const medicalInsuranceExpiryDate = document.getElementById('medicalInsuranceExpiryDate').value;
                const contractEndDate = document.getElementById('contractEndDate').value;
                
                if (contractDuration) employeeData.contractDuration = parseInt(contractDuration);
                if (contractLeaveDays) employeeData.contractLeaveDays = parseInt(contractLeaveDays);
                if (passportNumber) employeeData.passportNumber = passportNumber;
                if (passportExpiryDate) employeeData.passportExpiryDate = passportExpiryDate;
                if (workPermitExpiryDate) employeeData.workPermitExpiryDate = workPermitExpiryDate;
                if (passportFeesExpiryDate) employeeData.passportFeesExpiryDate = passportFeesExpiryDate;
                if (medicalInsuranceExpiryDate) employeeData.medicalInsuranceExpiryDate = medicalInsuranceExpiryDate;
                if (contractEndDate) employeeData.contractEndDate = contractEndDate;
            }
            
            // Add end of service fields (optional)
            const terminationReason = document.getElementById('terminationReason').value;
            const terminationDate = document.getElementById('terminationDate').value;
            if (terminationReason) employeeData.terminationReason = terminationReason;
            if (terminationDate) employeeData.terminationDate = terminationDate;

            try {
                const apiUrl = Config.getApiUrl();
                const editId = form.dataset.editId;
                const url = editId ? `${apiUrl}/employees/${editId}` : `${apiUrl}/employees`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(employeeData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert.textContent = editId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!';
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    
                    form.reset();
                    if (editId) {
                        cancelEdit();
                        switchTab('employees');  // switchTab will call loadEmployees() automatically
                    }
                } else {
                    throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
                }
            } catch (error) {
                alert.textContent = error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                setTimeout(() => { alert.style.display = 'none'; }, 5000);
            }
        });

        async function approveLeave(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©ØŸ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/leaves/${id}/approve`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingLeaves();
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©');
            }
        }

        async function rejectLeave(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©ØŸ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/leaves/${id}/reject`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingLeaves();
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©');
            }
        }

        async function approveAdvance(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©ØŸ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/advances/${id}/approve`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingAdvances();
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„ÙØ©');
            }
        }

        async function rejectAdvance(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©ØŸ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/advances/${id}/reject`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingAdvances();
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø³Ù„ÙØ©');
            }
        }

        function getLeaveTypeName(type) {
            const types = {
                'ANNUAL': 'Ø³Ù†ÙˆÙŠØ©',
                'annual': 'Ø³Ù†ÙˆÙŠØ©',
                'SICK': 'Ù…Ø±Ø¶ÙŠØ©',
                'sick': 'Ù…Ø±Ø¶ÙŠØ©',
                'EMERGENCY': 'Ø·Ø§Ø±Ø¦Ø©',
                'emergency': 'Ø·Ø§Ø±Ø¦Ø©',
                'UNPAID': 'Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨',
                'unpaid': 'Ø¨Ø¯ÙˆÙ† Ø±Ø§ØªØ¨'
            };
            return types[type] || type;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Edit Employee
        async function editEmployee(id) {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employee = await response.json();
                
                // Fill the form with employee data
                document.getElementById('fullName').value = employee.fullName;
                document.getElementById('employeeNumber').value = employee.employeeNumber;
                document.getElementById('nationalId').value = employee.nationalId;
                document.getElementById('email').value = employee.email || '';
                document.getElementById('phone').value = employee.phone || '';
                document.getElementById('department').value = employee.department || '';
                document.getElementById('jobTitle').value = employee.jobTitle || '';
                document.getElementById('hireDate').value = employee.hireDate ? employee.hireDate.split('T')[0] : '';
                document.getElementById('basicSalary').value = employee.basicSalary || '';
                document.getElementById('housingAllowance').value = employee.housingAllowance || '';
                document.getElementById('transportAllowance').value = employee.transportAllowance || '';
                document.getElementById('nationality').value = employee.nationality || '';
                
                // Fill non-Saudi fields if applicable
                if (employee.nationality === 'NON_SAUDI') {
                    document.getElementById('contractDuration').value = employee.contractDuration || '';
                    document.getElementById('contractLeaveDays').value = employee.contractLeaveDays || '';
                    document.getElementById('passportNumber').value = employee.passportNumber || '';
                    document.getElementById('passportExpiryDate').value = employee.passportExpiryDate ? employee.passportExpiryDate.split('T')[0] : '';
                    document.getElementById('workPermitExpiryDate').value = employee.workPermitExpiryDate ? employee.workPermitExpiryDate.split('T')[0] : '';
                    document.getElementById('passportFeesExpiryDate').value = employee.passportFeesExpiryDate ? employee.passportFeesExpiryDate.split('T')[0] : '';
                    document.getElementById('medicalInsuranceExpiryDate').value = employee.medicalInsuranceExpiryDate ? employee.medicalInsuranceExpiryDate.split('T')[0] : '';
                }
                
                // Toggle non-Saudi fields visibility
                toggleNonSaudiFields();
                
                // Change form to edit mode
                const form = document.getElementById('addEmployeeForm');
                form.dataset.editId = id;
                
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù';
                submitBtn.style.background = '#FF9800';
                
                // Switch to add employee tab
                switchTab('addEmployee');
                
                // Add cancel button if not exists
                if (!document.getElementById('cancelEditBtn')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancelEditBtn';
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                    cancelBtn.style.cssText = 'background: #9e9e9e; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;';
                    cancelBtn.onclick = cancelEdit;
                    submitBtn.parentElement.insertBefore(cancelBtn, submitBtn);
                }
            } catch (error) {
                console.error('Error loading employee:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù: ' + (error.message || 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±'));
            }
        }

        // Cancel Edit
        function cancelEdit() {
            const form = document.getElementById('addEmployeeForm');
            form.reset();
            delete form.dataset.editId;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù';
            submitBtn.style.background = '';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.remove();
        }

        // Delete Employee
        async function deleteEmployee(id, name) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${name}ØŸ`)) {
                return;
            }
            
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
                    loadEmployees();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù');
                console.error('Error deleting employee:', error);
            }
        }

        // Resend Activation Email
        async function resendActivationEmail(employeeId, employeeName) {
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„Ù…ÙˆØ¸Ù: ${employeeName}ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.`)) {
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            button.disabled = true;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/employees/${employeeId}/resend-activation`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:\n${result.email}\n\nØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${result.username}`);
                } else {
                    const error = await response.json();
                    alert(`âŒ ${error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'}`);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
                console.error('Error resending activation email:', error);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Settings Functions
        let departments = [];
        let jobTitles = [];

        async function loadSettings() {
            await Promise.all([
                loadCompanySettings(),
                loadDepartments(),
                loadJobTitles()
            ]);
            await loadDepartmentsAndJobTitlesForForm();
        }

        async function loadCompanySettings() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/company`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const settings = await response.json();
                
                if (settings) {
                    document.getElementById('companyName').value = settings.companyName || '';
                    document.getElementById('companyNameEn').value = settings.companyNameEn || '';
                    document.getElementById('companyEmail').value = settings.email || '';
                    document.getElementById('companyPhone').value = settings.phone || '';
                    document.getElementById('companyAddress').value = settings.address || '';
                    document.getElementById('taxNumber').value = settings.taxNumber || '';
                    
                    // Load logo if exists
                    if (settings.logo) {
                        displayLogo(settings.logo);
                    }
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        }

        // Logo Management Functions
        let currentLogo = null;

        function displayLogo(logoData) {
            currentLogo = logoData;
            const logoImage = document.getElementById('logoImage');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            
            if (logoData) {
                logoImage.src = logoData;
                logoImage.style.display = 'block';
                logoPlaceholder.style.display = 'none';
            } else {
                logoImage.style.display = 'none';
                logoPlaceholder.style.display = 'block';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.match('image/(png|jpeg|jpg)')) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© PNG Ø£Ùˆ JPG');
                return;
            }

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return;
            }

            // Read and display the image
            const reader = new FileReader();
            reader.onload = function(e) {
                displayLogo(e.target.result);
                // Auto-save logo
                saveLogo(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function saveLogo(logoData) {
            try {
                const apiUrl = Config.getApiUrl();
                const settings = {
                    companyName: document.getElementById('companyName').value,
                    companyNameEn: document.getElementById('companyNameEn').value,
                    email: document.getElementById('companyEmail').value,
                    phone: document.getElementById('companyPhone').value,
                    address: document.getElementById('companyAddress').value,
                    taxNumber: document.getElementById('taxNumber').value,
                    logo: logoData
                };

                const response = await fetch(`${apiUrl}/settings/company`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('ØªÙ… Ø­ÙØ¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­! âœ…');
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©: ' + error.message);
                console.error('Error saving logo:', error);
            }
        }

        function removeLogo() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©ØŸ')) return;
            
            displayLogo(null);
            saveLogo(null);
        }

        async function loadDepartments() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/departments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                departments = await response.json();
                displayDepartments();
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadJobTitles() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/job-titles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                jobTitles = await response.json();
                displayJobTitles();
            } catch (error) {
                console.error('Error loading job titles:', error);
            }
        }

        function displayDepartments() {
            const container = document.getElementById('departmentsList');
            if (!departments || departments.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p>';
                return;
            }

            container.innerHTML = departments.map(dept => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px;">
                    <span style="font-weight: 500;">${dept.name}</span>
                    <button onclick="deleteDepartment(${dept.id})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        function displayJobTitles() {
            const container = document.getElementById('jobTitlesList');
            if (!jobTitles || jobTitles.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ù…ÙŠØ§Øª ÙˆØ¸ÙŠÙÙŠØ©</p>';
                return;
            }

            container.innerHTML = jobTitles.map(title => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px;">
                    <span style="font-weight: 500;">${title.title}</span>
                    <button onclick="deleteJobTitle(${title.id})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        async function addDepartment() {
            const input = document.getElementById('newDepartment');
            const name = input.value.trim();
            
            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…');
                return;
            }

            try {
                const apiUrl = Config.getApiUrl();
                console.log('Sending department:', { name });
                const response = await fetch(`${apiUrl}/settings/departments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    input.value = '';
                    await loadDepartments();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert(`ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…: ${result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
                }
            } catch (error) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…: ${error.message}`);
                console.error('Error adding department:', error);
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/departments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadDepartments();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…');
                console.error('Error deleting department:', error);
            }
        }

        async function addJobTitle() {
            const input = document.getElementById('newJobTitle');
            const title = input.value.trim();
            
            if (!title) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
                return;
            }

            try {
                const apiUrl = Config.getApiUrl();
                console.log('Sending job title:', { title });
                const response = await fetch(`${apiUrl}/settings/job-titles`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    input.value = '';
                    await loadJobTitles();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert(`ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
                }
            } catch (error) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${error.message}`);
                console.error('Error adding job title:', error);
            }
        }

        async function deleteJobTitle(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŸ')) return;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/job-titles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadJobTitles();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
                console.error('Error deleting job title:', error);
            }
        }

        async function loadDepartmentsAndJobTitlesForForm() {
            const apiUrl = Config.getApiUrl();
            const deptSelect = document.getElementById('department');
            const jobSelect = document.getElementById('jobTitle');

            // Load departments
            const deptsResponse = await fetch(`${apiUrl}/settings/departments`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const depts = await deptsResponse.json();
            
            deptSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>' +
                depts.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

            // Load job titles
            const jobsResponse = await fetch(`${apiUrl}/settings/job-titles`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const jobs = await jobsResponse.json();
            
            jobSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ --</option>' +
                jobs.map(j => `<option value="${j.title}">${j.title}</option>`).join('');
        }

        // Company Settings Form
        document.getElementById('companySettingsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                companyName: document.getElementById('companyName').value,
                companyNameEn: document.getElementById('companyNameEn').value,
                email: document.getElementById('companyEmail').value,
                phone: document.getElementById('companyPhone').value,
                address: document.getElementById('companyAddress').value,
                taxNumber: document.getElementById('taxNumber').value,
            };

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/company`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                console.error('Error saving settings:', error);
            }
        });

        // Load initial dashboard data and form options
        loadDashboard();
        loadDepartmentsAndJobTitlesForForm();
        
        // ============= EXPORT FUNCTIONS =============
        
        function exportToExcel() {
            if (!window.employeesData || window.employeesData.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            const nationalityNames = { 'SAUDI': 'Ø³Ø¹ÙˆØ¯ÙŠ', 'NON_SAUDI': 'ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ' };
            const workTypeNames = { 'FULL_TIME': 'Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„', 'PART_TIME': 'Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ', 'REMOTE': 'Ø¹Ù† Ø¨Ø¹Ø¯', 'CONTRACT': 'Ø¹Ù‚Ø¯ Ù…Ø¤Ù‚Øª' };
            const sponsorshipNames = { 'COMPANY': 'Ø§Ù„Ø´Ø±ÙƒØ©', 'PERSONAL': 'Ø´Ø®ØµÙŠØ©', 'EXTERNAL': 'Ø®Ø§Ø±Ø¬ÙŠØ©' };
            const ticketClassNames = { 'ECONOMY': 'Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©', 'BUSINESS': 'Ø£Ø¹Ù…Ø§Ù„' };
            const terminationReasonNames = { 'NORMAL_END': 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø·Ø¨ÙŠØ¹ÙŠ', 'RESIGNATION': 'Ø§Ø³ØªÙ‚Ø§Ù„Ø©', 'TERMINATION': 'Ø¥Ù†Ù‡Ø§Ø¡' };
            
            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
            const exportData = window.employeesData.map(emp => {
                const totalSalary = (parseFloat(emp.basicSalary) || 0) + (parseFloat(emp.housingAllowance) || 0) + (parseFloat(emp.transportAllowance) || 0);
                
                return {
                    'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù': emp.employeeNumber,
                    'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„': emp.fullName,
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': emp.nationalId || '',
                    'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': emp.email || '',
                    'Ø§Ù„Ù‡Ø§ØªÙ': emp.phone || '',
                    'Ø§Ù„Ù‚Ø³Ù…': emp.department || '',
                    'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ': emp.jobTitle || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†': emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '',
                    'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ': emp.basicSalary || 0,
                    'Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†': emp.housingAllowance || 0,
                    'Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„': emp.transportAllowance || 0,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨': totalSalary,
                    'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©': nationalityNames[emp.nationality] || emp.nationality,
                    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„': workTypeNames[emp.workType] || emp.workType || '',
                    'Ù†ÙˆØ¹ Ø§Ù„ÙƒÙØ§Ù„Ø©': sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '',
                    'Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©': emp.ticketEntitlement ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                    'Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©': ticketClassNames[emp.ticketClass] || emp.ticketClass || '',
                    'Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ (Ø´Ù‡ÙˆØ±)': emp.contractDuration || '',
                    'Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©': emp.contractLeaveDays || '',
                    'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²': emp.passportNumber || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²': emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø®ØµØ© Ø§Ù„Ø¹Ù…Ù„': emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ': emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯': emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '',
                    'Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©': terminationReasonNames[emp.terminationReason] || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©': emp.terminationDate ? new Date(emp.terminationDate).toLocaleDateString('ar-SA') : ''
                };
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†');
            
            // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            const fileName = `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function exportToPDF() {
            if (!window.employeesData || window.employeesData.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            const nationalityNames = { 'SAUDI': 'Ø³Ø¹ÙˆØ¯ÙŠ', 'NON_SAUDI': 'ØºÙŠØ± Ø³Ø¹ÙˆØ¯ÙŠ' };
            const workTypeNames = { 'FULL_TIME': 'Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„', 'PART_TIME': 'Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ', 'REMOTE': 'Ø¹Ù† Ø¨Ø¹Ø¯', 'CONTRACT': 'Ø¹Ù‚Ø¯ Ù…Ø¤Ù‚Øª' };
            const sponsorshipNames = { 'COMPANY': 'Ø§Ù„Ø´Ø±ÙƒØ©', 'PERSONAL': 'Ø´Ø®ØµÙŠØ©', 'EXTERNAL': 'Ø®Ø§Ø±Ø¬ÙŠØ©' };
            
            // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            doc.setFontSize(16);
            doc.text('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
            
            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„ - ØµÙØ­Ø© 1: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const tableData1 = window.employeesData.map(emp => {
                const totalSalary = (parseFloat(emp.basicSalary) || 0) + (parseFloat(emp.housingAllowance) || 0) + (parseFloat(emp.transportAllowance) || 0);
                return [
                    emp.employeeNumber,
                    emp.fullName,
                    emp.nationalId || '-',
                    emp.email || '-',
                    emp.phone || '-',
                    emp.department || '-',
                    emp.jobTitle || '-',
                    emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '-',
                    emp.basicSalary || 0,
                    emp.housingAllowance || 0,
                    emp.transportAllowance || 0,
                    totalSalary.toFixed(2)
                ];
            });
            
            doc.autoTable({
                startY: 28,
                head: [['Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù', 'Ø§Ù„Ø§Ø³Ù…', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„ÙˆØ¸ÙŠÙØ©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', 'Ø§Ù„Ø³ÙƒÙ†', 'Ø§Ù„Ù†Ù‚Ù„', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ']],
                body: tableData1,
                styles: { 
                    font: 'helvetica',
                    fontSize: 7,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: 255,
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { top: 28, left: 5, right: 5 }
            });
            
            // ØµÙØ­Ø© 2: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            doc.addPage();
            doc.setFontSize(14);
            doc.text('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            
            const tableData2 = window.employeesData.map(emp => [
                emp.employeeNumber,
                emp.fullName,
                nationalityNames[emp.nationality] || emp.nationality,
                workTypeNames[emp.workType] || emp.workType || '-',
                sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '-',
                emp.ticketEntitlement ? 'Ù†Ø¹Ù…' : 'Ù„Ø§',
                emp.contractDuration || '-',
                emp.contractLeaveDays || '-'
            ]);
            
            doc.autoTable({
                startY: 22,
                head: [['Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„', 'Ø§Ù„ÙƒÙØ§Ù„Ø©', 'Ø§Ù„ØªØ°ÙƒØ±Ø©', 'Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯', 'Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©']],
                body: tableData2,
                styles: { 
                    font: 'helvetica',
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { left: 5, right: 5 }
            });
            
            // ØµÙØ­Ø© 3: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠÙŠÙ†
            const nonSaudiEmployees = window.employeesData.filter(emp => emp.nationality === 'NON_SAUDI');
            if (nonSaudiEmployees.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØºÙŠØ± Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠÙŠÙ†', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                
                const tableData3 = nonSaudiEmployees.map(emp => [
                    emp.employeeNumber,
                    emp.fullName,
                    emp.passportNumber || '-',
                    emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '-'
                ]);
                
                doc.autoTable({
                    startY: 22,
                    head: [['Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù', 'Ø§Ù„Ø§Ø³Ù…', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ø²', 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²', 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø®ØµØ© Ø§Ù„Ø¹Ù…Ù„', 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†', 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯']],
                    body: tableData3,
                    styles: { 
                        font: 'helvetica',
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { left: 5, right: 5 }
                });
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
            const fileName = `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        
        // Auto-refresh for pending requests every 30 seconds
        setInterval(() => {
            const currentTab = document.querySelector('.tab-btn.active')?.textContent;
            if (currentTab === 'Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª') {
                loadPendingLeaves();
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª');
            } else if (currentTab === 'Ø§Ù„Ø³Ù„Ù') {
                loadPendingAdvances();
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ù„Ù');
            }
        }, 30000);
    </script>
</body>
</html>
