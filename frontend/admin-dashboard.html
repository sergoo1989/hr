<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุฅุฏุงุฑุฉ - ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="analytics-functions.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: #f8f9fa;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .approve-btn {
            background: #28a745;
            color: white;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Analytics Styles */
        .analytics-section {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .analytics-table thead {
            background: #f8f9fa;
        }

        .analytics-table th {
            padding: 12px;
            text-align: right;
            color: #555;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .analytics-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            color: #333;
        }

        .analytics-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-danger {
            background: #ff5252;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-success {
            background: #4caf50;
            color: white;
        }

        .badge-info {
            background: #2196f3;
            color: white;
        }
        
        /* Table styles for better display */
        #employeesList table {
            font-size: 12px;
            width: 100%;
            overflow-x: auto;
            display: block;
        }
        
        #employeesList table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        #employeesList table th {
            white-space: nowrap;
            padding: 10px 8px;
            font-size: 11px;
        }
        
        #employeesList table td {
            white-space: nowrap;
            padding: 8px 6px;
            font-size: 11px;
        }
    </style>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amiri-font@1.0.3/dist/amiri.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ููุญุฉ ุงูุฅุฏุงุฑุฉ</h1>
            <div class="user-info">
                <span id="currentUsername"></span>
                <button class="logout-btn" onclick="logout()">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', event)">ููุญุฉ ุงููุนูููุงุช</button>
            <button class="tab" onclick="switchTab('analytics', event)">๐ ุงูุชุญูููุงุช ุงููุชูุฏูุฉ</button>
            <a href="payroll-report.html" class="tab" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">๐ฐ ูุณูุฑ ุงูุฑูุงุชุจ</a>
            <a href="assets.html" class="tab" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">๐ฆ ุงูุนูุฏ ุงูุนูููุฉ</a>
            <button class="tab" onclick="switchTab('backup', event)">๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู</button>
            <button class="tab" onclick="switchTab('addEmployee', event)">ุฅุถุงูุฉ ููุธู</button>
            <button class="tab" onclick="switchTab('employees', event)">ุงูููุธููู</button>
            <button class="tab" onclick="switchTab('users', event)">๐ ุงูููุฒุฑุงุช ูุงูุจุงุณูุฑุฏุงุช</button>
            <button class="tab" onclick="switchTab('leaves', event)">ุงูุฅุฌุงุฒุงุช</button>
            <button class="tab" onclick="switchTab('advances', event)">ุงูุณูู</button>
            <button class="tab" onclick="switchTab('settings', event)">ุงูุฅุนุฏุงุฏุงุช</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">-</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงูููุธููู</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingLeaves">-</div>
                    <div class="stat-label">ุฅุฌุงุฒุงุช ูุนููุฉ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingAdvancesCount">-</div>
                    <div class="stat-label">ุณูู ูุนููุฉ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                    <div class="stat-value" id="expiringDocuments" style="color: white;">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">ูุซุงุฆู ูุฑูุจุฉ ุงูุงูุชูุงุก</div>
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup" class="tab-content">
            <div class="section">
                <h2>๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ</h2>
                
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #856404; margin-bottom: 10px;">โ๏ธ ุชุญุฐูุฑ ูุงู</h3>
                    <ul style="color: #856404; padding-right: 20px; line-height: 1.8;">
                        <li>ุงุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุฃู ุชุนุฏููุงุช ูุจูุฑุฉ</li>
                        <li>ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุณุชุณุชุจุฏู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ</li>
                        <li>ุชุฃูุฏ ูู ุตุญุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูุจู ุงูุงุณุชุนุงุฏุฉ</li>
                        <li>ูุชู ุงูุญูุธ ุงูุชููุงุฆู ูู 30 ุซุงููุฉ</li>
                    </ul>
                </div>

                <!-- Backup Info -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 15px;">๐ ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช</h4>
                        <div id="backupStats" style="line-height: 2;">ุฌุงุฑู ุงูุชุญููู...</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #4caf50; margin-bottom: 15px;">โฐ ุขุฎุฑ ุญูุธ</h4>
                        <div id="lastSaved" style="font-size: 14px; color: #666;">ุฌุงุฑู ุงูุชุญููู...</div>
                    </div>
                </div>

                <!-- Backup Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Download Backup -->
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">๐ฅ</div>
                        <h3 style="margin-bottom: 15px; color: #667eea;">ุชุญููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                            ุงุญูุธ ุฌููุน ุจูุงูุงุช ุงููุธุงู ูู ููู JSON
                        </p>
                        <button onclick="downloadBackup()" class="btn" style="background: #667eea; width: 100%; padding: 15px;">
                            ๐ฅ ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                        </button>
                    </div>

                    <!-- Restore Backup -->
                    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">๐ค</div>
                        <h3 style="margin-bottom: 15px; color: #ff9800;">ุงุณุชุนุงุฏุฉ ูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                            ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุงุจูุฉ
                        </p>
                        <label for="backupFile" class="btn" style="background: #ff9800; width: 100%; padding: 15px; cursor: pointer; display: inline-block;">
                            ๐ค ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                            <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="handleBackupFile(event)">
                        </label>
                    </div>
                </div>

                <!-- Manual Save -->
                <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">๐พ</div>
                    <h3 style="margin-bottom: 15px; color: #4caf50;">ุญูุธ ูุฏูู ููุจูุงูุงุช</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        ุงุญูุธ ุงูุจูุงูุงุช ุงูุญุงููุฉ ูู ุงูููู ุงูุฑุฆูุณู (ูุชู ุงูุญูุธ ุชููุงุฆูุงู ูู 30 ุซุงููุฉ)
                    </p>
                    <button onclick="manualSave()" class="btn" style="background: #4caf50; padding: 15px; min-width: 200px;">
                        ๐พ ุญูุธ ุงูุขู
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Employee Tab -->
        <div id="addEmployee" class="tab-content">
            <div class="section">
                <h2>ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</h2>
                <div id="addEmployeeAlert" class="alert"></div>
                
                <!-- Excel Upload Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">๐ ุฅุถุงูุฉ ููุธููู ูู ููู Excel</h3>
                    <p style="color: #2e7d32; margin-bottom: 15px; font-size: 14px;">
                        ููููู ุฅุถุงูุฉ ุนุฏุฉ ููุธููู ุฏูุนุฉ ูุงุญุฏุฉ ูู ุฎูุงู ุฑูุน ููู Excel
                    </p>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="downloadExcelTemplate()" style="background: #2e7d32;">
                            ๐ฅ ุชุญููู ูุงูุจ Excel
                        </button>
                        <label for="excelFile" class="btn" style="background: #1976d2; cursor: pointer; margin: 0;">
                            ๐ค ุฑูุน ููู Excel
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                        </label>
                        <span id="excelFileName" style="color: #2e7d32; font-weight: bold;"></span>
                    </div>
                    <div id="excelUploadAlert" class="alert" style="margin-top: 15px;"></div>
                    <div id="excelPreview" style="margin-top: 20px; display: none;">
                        <h4 style="color: #2e7d32;">ูุนุงููุฉ ุงูุจูุงูุงุช:</h4>
                        <div style="overflow-x: auto; max-height: 400px;">
                            <table id="excelPreviewTable" style="width: 100%; border-collapse: collapse; background: white;">
                                <thead id="excelPreviewHeader"></thead>
                                <tbody id="excelPreviewBody"></tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button type="button" class="btn" onclick="uploadEmployeesFromExcel()" style="background: #1976d2;">
                                โ ุญูุธ ุงูููุธููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                            </button>
                            <button type="button" class="btn" onclick="cancelExcelUpload()" style="background: #f44336;">
                                โ ุฅูุบุงุก
                            </button>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #666;">ุฃู ุฅุถุงูุฉ ููุธู ูุฏููุงู:</h3>
                <form id="addEmployeeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">ุงูุงุณู ุงููุงูู *</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="employeeNumber">ุฑูู ุงูููุธู (ุชููุงุฆู)</label>
                            <input type="text" id="employeeNumber" readonly style="background: #f0f0f0; cursor: not-allowed;" placeholder="ุณูุชู ุฅูุดุงุคู ุชููุงุฆูุงู">
                        </div>
                        <div class="form-group">
                            <label for="nationalId">ุฑูู ุงููููุฉ *</label>
                            <input type="text" id="nationalId" required>
                        </div>
                        <div class="form-group" id="usernameGroup">
                            <label for="usernameInput">ุงุณู ุงููุณุชุฎุฏู *</label>
                            <input type="text" id="usernameInput" required placeholder="ุงุณู ุงููุณุชุฎุฏู ููุฏุฎูู ูููุธุงู">
                        </div>
                        <div class="form-group" id="passwordGroup">
                            <label for="userPassword">ูููุฉ ุงููุฑูุฑ *</label>
                            <input type="password" id="userPassword" required placeholder="ูููุฉ ุงููุฑูุฑ ููุฏุฎูู">
                        </div>
                        <div class="form-group" id="roleGroup">
                            <label for="userRole">ุงูุตูุงุญูุฉ *</label>
                            <select id="userRole" required>
                                <option value="">-- ุงุฎุชุฑ ุงูุตูุงุญูุฉ --</option>
                                <option value="EMPLOYEE">ููุธู</option>
                                <option value="ADMIN">ูุฏูุฑ ูุธุงู</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input type="email" id="email">
                        </div>
                        <div class="form-group">
                            <label for="phone">ุฑูู ุงูุฌูุงู</label>
                            <input type="tel" id="phone">
                        </div>
                        <div class="form-group">
                            <label for="department">ุงููุณู *</label>
                            <select id="department" required>
                                <option value="">-- ุงุฎุชุฑ ุงููุณู --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="jobTitle">ุงููุณูู ุงููุธููู *</label>
                            <select id="jobTitle" required>
                                <option value="">-- ุงุฎุชุฑ ุงููุณูู ุงููุธููู --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hireDate">ุชุงุฑูุฎ ุงูุชุนููู *</label>
                            <input type="date" id="hireDate" required>
                        </div>
                        <div class="form-group">
                            <label for="basicSalary">ุงูุฑุงุชุจ ุงูุฃุณุงุณู *</label>
                            <input type="number" id="basicSalary" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="housingAllowance">ุจุฏู ุงูุณูู</label>
                            <input type="number" id="housingAllowance" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="transportAllowance">ุจุฏู ุงูููู</label>
                            <input type="number" id="transportAllowance" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="nationality">ุงูุฌูุณูุฉ</label>
                            <select id="nationality" onchange="toggleNonSaudiFields()">
                                <option value="SAUDI">ุณุนูุฏู</option>
                                <option value="NON_SAUDI">ุบูุฑ ุณุนูุฏู</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workType">ููุน ุงูุนูู</label>
                            <select id="workType">
                                <option value="FULL_TIME">ุฏูุงู ูุงูู</option>
                                <option value="PART_TIME">ุฏูุงู ุฌุฒุฆู (Part-Time)</option>
                                <option value="REMOTE">ุนู ุจุนุฏ</option>
                                <option value="CONTRACT">ุนูุฏ ูุคูุช</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contractDuration">ูุฏุฉ ุงูุนูุฏ (ุจุงูุฃุดูุฑ)</label>
                            <input type="number" id="contractDuration" min="1">
                        </div>
                        <div class="form-group">
                            <label for="contractLeaveDays">ุนุฏุฏ ุฃูุงู ุงูุฅุฌุงุฒุฉ ุจุงูุนูุฏ</label>
                            <input type="number" id="contractLeaveDays" min="0">
                        </div>
                        <div class="form-group">
                            <label for="contractEndDate">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ</label>
                            <input type="date" id="contractEndDate">
                        </div>
                        <div class="form-group">
                            <label for="medicalInsuranceExpiryDate">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุชุฃููู ุงูุทุจู</label>
                            <input type="date" id="medicalInsuranceExpiryDate">
                        </div>
                    </div>
                    
                    <!-- Non-Saudi Employee Additional Fields -->
                    <div id="nonSaudiFields" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #007bff;">
                        <h3 style="color: #007bff; margin-bottom: 15px;">ูุนูููุงุช ุงูููุธู ุบูุฑ ุงูุณุนูุฏู</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="sponsorshipType">ููุน ุงูููุงูุฉ *</label>
                                <select id="sponsorshipType">
                                    <option value="COMPANY">ููุงูุฉ ุงูุดุฑูุฉ</option>
                                    <option value="PERSONAL">ููุงูุฉ ุดุฎุตูุฉ</option>
                                    <option value="EXTERNAL">ุนูุงูุฉ ุฎุงุฑุฌูุฉ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ticketEntitlement">ุงุณุชุญูุงู ุงูุชุฐูุฑุฉ *</label>
                                <select id="ticketEntitlement">
                                    <option value="false">ูุง</option>
                                    <option value="true">ูุนู</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ticketClass">ุฏุฑุฌุฉ ุงูุชุฐูุฑุฉ *</label>
                                <select id="ticketClass">
                                    <option value="ECONOMY">ุงูุชุตุงุฏูุฉ</option>
                                    <option value="BUSINESS">ุฏุฑุฌุฉ ุฃุนูุงู</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="passportNumber">ุฑูู ุงูุฌูุงุฒ</label>
                                <input type="text" id="passportNumber">
                            </div>
                            <div class="form-group">
                                <label for="passportExpiryDate">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฌูุงุฒ</label>
                                <input type="date" id="passportExpiryDate">
                            </div>
                            <div class="form-group">
                                <label for="workPermitExpiryDate">ุชุงุฑูุฎ ุงูุชูุงุก ุฑุฎุตุฉ ุงูุนูู</label>
                                <input type="date" id="workPermitExpiryDate">
                            </div>
                            <div class="form-group">
                                <label for="passportFeesExpiryDate">ุชุงุฑูุฎ ุงูุชูุงุก ุฑุณูู ุงูุฌูุงุฒุงุช</label>
                                <input type="date" id="passportFeesExpiryDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- End of Service Section -->
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 15px;">๐ ูุนูููุงุช ููุงูุฉ ุงูุฎุฏูุฉ (ุงุฎุชูุงุฑู)</h3>
                        <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">ูุฐู ุงููุนูููุงุช ุชุณุชุฎุฏู ูุญุณุงุจ ููุงูุฃุฉ ููุงูุฉ ุงูุฎุฏูุฉ ุญุณุจ ูุงููู ุงูุนูู ุงูุณุนูุฏู</p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="terminationReason">ุณุจุจ ุงูุชูุงุก ุงูุฎุฏูุฉ</label>
                                <select id="terminationReason">
                                    <option value="">-- ูู ููุชูู ุจุนุฏ --</option>
                                    <option value="NORMAL_END">ุงูุชูุงุก ุทุจูุนู ููุนูุฏ</option>
                                    <option value="RESIGNATION">ุงุณุชูุงูุฉ ุงูููุธู</option>
                                    <option value="TERMINATION">ุฅููุงุก ูู ุตุงุญุจ ุงูุนูู</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="terminationDate">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฎุฏูุฉ</label>
                                <input type="date" id="terminationDate">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button type="submit" class="btn" id="submitBtn">ุฅุถุงูุฉ ุงูููุธู</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="employees" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ูุงุฆูุฉ ุงูููุธููู</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportToExcel()" class="btn" style="background: #28a745; padding: 10px 20px;">
                            ๐ ุชุตุฏูุฑ Excel
                        </button>
                        <button onclick="exportToPDF()" class="btn" style="background: #dc3545; padding: 10px 20px;">
                            ๐ ุชุตุฏูุฑ PDF
                        </button>
                    </div>
                </div>
                <div id="employeesList"></div>
            </div>
        </div>

        <!-- Users & Passwords Tab -->
        <div id="users" class="tab-content">
            <div class="section">
                <h2>๐ ูุงุฆูุฉ ุงูููุฒุฑุงุช ูุงูุจุงุณูุฑุฏุงุช</h2>
                <p style="color: #d32f2f; padding: 10px; background: #ffebee; border-radius: 5px; margin-bottom: 20px;">
                    โ๏ธ <strong>ุชุญุฐูุฑ:</strong> ูุฐู ุงููุนูููุงุช ุณุฑูุฉ ููุบุงูุฉ. ุงุญูุธูุง ูู ููุงู ุขูู ููุง ุชุดุงุฑููุง ูุน ุฃุญุฏ.
                </p>
                <div id="usersList"></div>
            </div>
        </div>

        <!-- Leaves Tab -->
        <div id="leaves" class="tab-content">
            <div class="section">
                <h2>ุทูุจุงุช ุงูุฅุฌุงุฒุงุช ุงููุนููุฉ</h2>
                <div id="leavesList"></div>
            </div>
        </div>

        <!-- Advances Tab -->
        <div id="advances" class="tab-content">
            <div class="section">
                <h2>ุทูุจุงุช ุงูุณูู ุงููุนููุฉ</h2>
                <div id="advancesList"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div id="analyticsLoading" style="text-align: center; padding: 50px; color: #667eea; font-size: 20px;">
                ุฌุงุฑู ุชุญููู ุงูุชุญูููุงุช...
            </div>
            
            <div id="analyticsContent" style="display: none;">
                <!-- Statistics Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;" id="analyticsStatsGrid"></div>

                <!-- Navigation Sub-Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="btn" style="background: #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('overview')">ูุธุฑุฉ ุนุงูุฉ</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('leaveBalances')">ุฃุฑุตุฏุฉ ุงูุฅุฌุงุฒุงุช</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('endOfService')">ููุงูุฉ ุงูุฎุฏูุฉ</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('assetsAnalysis')">ุงูุนูุฏ ุงูุนูููุฉ</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('ticketsAnalysis')">ุงูุชุฐุงูุฑ</button>
                    <button class="btn" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 20px;" onclick="switchAnalyticsSection('documentsAlerts')">ุงูุชูุจููุงุช</button>
                </div>

                <!-- Overview Section - Charts -->
                <div id="analyticsOverview" class="analytics-section" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ุชูุฒูุน ุงูููุธููู ุญุณุจ ุงููุณู</h3>
                            <canvas id="departmentChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ุชูุฒูุน ุงูููุธููู ุญุณุจ ุงูุฌูุณูุฉ</h3>
                            <canvas id="nationalityChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ุชูุฒูุน ุงูุฅุฌุงุฒุงุช</h3>
                            <canvas id="leaveTypeChart"></canvas>
                        </div>
                        <div class="section">
                            <h3 style="color: #333; margin-bottom: 20px;">ุชูุฒูุน ุงูุฑูุงุชุจ</h3>
                            <canvas id="salaryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Leave Balances Section -->
                <div id="analyticsLeaveBalances" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช ููููุธููู</h2>
                        <div id="leaveBalancesTable"></div>
                    </div>
                </div>

                <!-- End of Service Section -->
                <div id="analyticsEndOfService" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ุญุณุงุจ ููุงูุฃุฉ ููุงูุฉ ุงูุฎุฏูุฉ</h2>
                        <div id="endOfServiceTable"></div>
                    </div>
                </div>

                <!-- Assets Analysis Section -->
                <div id="analyticsAssetsAnalysis" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>๐ฆ ุชุญููู ุงูุนูุฏ ุงูุนูููุฉ</h2>
                        <div id="assetsAnalysisTable"></div>
                    </div>
                </div>

                <!-- Tickets Section -->
                <div id="analyticsTicketsAnalysis" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ุงูููุธููู ุงููุณุชุญููู ููุชุฐุงูุฑ</h2>
                        <div id="ticketsAnalysisTable"></div>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div id="analyticsDocumentsAlerts" class="analytics-section" style="display: none;">
                    <div class="section">
                        <h2>ุชูุจููุงุช ุงููุซุงุฆู ุงููุฑูุจุฉ ูู ุงูุงูุชูุงุก</h2>
                        <div id="documentsAlertsTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ</h2>
                <form id="companySettingsForm">
                    <!-- Logo Upload Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">๐ข</span>
                            ุดุนุงุฑ ุงูุดุฑูุฉ
                        </h3>
                        <div style="display: flex; gap: 25px; align-items: start;">
                            <!-- Logo Preview -->
                            <div style="flex-shrink: 0;">
                                <div id="logoPreview" style="width: 150px; height: 150px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                                    <img id="logoImage" src="" style="max-width: 100%; max-height: 100%; display: none; object-fit: contain;">
                                    <span id="logoPlaceholder" style="color: #ccc; font-size: 14px; text-align: center; padding: 10px;">ูุง ููุฌุฏ ุดุนุงุฑ</span>
                                </div>
                            </div>
                            <!-- Logo Upload Controls -->
                            <div style="flex: 1;">
                                <p style="color: rgba(255,255,255,0.95); margin-bottom: 15px; line-height: 1.6;">
                                    ูู ุจุฑูุน ุดุนุงุฑ ุดุฑูุชู ุจุตูุบุฉ PNG ุฃู JPG. ุณูุธูุฑ ุงูุดุนุงุฑ ูู ุฌููุน ุงูุชูุงุฑูุฑ ูุงููุณุชูุฏุงุช ุงูุฑุณููุฉ.
                                </p>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <input type="file" id="logoUpload" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="handleLogoUpload(event)">
                                    <button type="button" onclick="document.getElementById('logoUpload').click()" class="btn" style="background: white; color: #667eea; padding: 10px 20px; font-weight: 600;">
                                        ๐ค ุงุฎุชุฑ ุงูุดุนุงุฑ
                                    </button>
                                    <button type="button" onclick="removeLogo()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; backdrop-filter: blur(10px);">
                                        ๐๏ธ ุฅุฒุงูุฉ ุงูุดุนุงุฑ
                                    </button>
                                </div>
                                <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 10px;">
                                    ุงูุญุฌู ุงูููุตู ุจู: 500x500 ุจูุณู | ุงูุญุฏ ุงูุฃูุตู: 2 ููุฌุงุจุงูุช
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="companyName">ุงุณู ุงูุดุฑูุฉ (ุนุฑุจู) *</label>
                            <input type="text" id="companyName" required>
                        </div>
                        <div class="form-group">
                            <label for="companyNameEn">ุงุณู ุงูุดุฑูุฉ (English)</label>
                            <input type="text" id="companyNameEn">
                        </div>
                        <div class="form-group">
                            <label for="companyEmail">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input type="email" id="companyEmail">
                        </div>
                        <div class="form-group">
                            <label for="companyPhone">ุฑูู ุงููุงุชู</label>
                            <input type="tel" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label for="companyAddress">ุงูุนููุงู</label>
                            <input type="text" id="companyAddress">
                        </div>
                        <div class="form-group">
                            <label for="taxNumber">ุงูุฑูู ุงูุถุฑูุจู</label>
                            <input type="text" id="taxNumber">
                        </div>
                    </div>
                    <button type="submit" class="btn">ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ</button>
                </form>
            </div>

            <div class="section" style="margin-top: 30px;">
                <h2>ุงููููู ุงูุฅุฏุงุฑู</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                    <!-- Departments -->
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">ุงูุฃูุณุงู</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="newDepartment" placeholder="ุงุณู ุงููุณู ุงูุฌุฏูุฏ" style="flex: 1;">
                            <button onclick="addDepartment()" class="btn" style="padding: 10px 20px;">ุฅุถุงูุฉ</button>
                        </div>
                        <div id="departmentsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <!-- Job Titles -->
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">ุงููุณููุงุช ุงููุธูููุฉ</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="newJobTitle" placeholder="ุงููุณูู ุงููุธููู ุงูุฌุฏูุฏ" style="flex: 1;">
                            <button onclick="addJobTitle()" class="btn" style="padding: 10px 20px;">ุฅุถุงูุฉ</button>
                        </div>
                        <div id="jobTitlesList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (!token) {
            window.location.href = 'login.html';
        }

        document.getElementById('currentUsername').textContent = username;

        function switchTab(tabName, event = null) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find and activate the tab button by onclick attribute
                const tabButton = Array.from(document.querySelectorAll('.tab')).find(
                    tab => tab.getAttribute('onclick')?.includes(`'${tabName}'`)
                );
                if (tabButton) tabButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'employees') loadEmployees();
            if (tabName === 'users') loadUsers();
            if (tabName === 'leaves') loadPendingLeaves();
            if (tabName === 'advances') loadPendingAdvances();
            if (tabName === 'settings') loadSettings();
            if (tabName === 'analytics') loadAnalytics();
        }

        async function loadDashboard() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await response.json();
                
                document.getElementById('totalEmployees').textContent = stats.totalEmployees || 0;
                document.getElementById('pendingLeaves').textContent = stats.pendingLeaves || 0;
                document.getElementById('pendingAdvancesCount').textContent = stats.pendingAdvances || 0;
                
                // Calculate expiring documents for non-Saudi employees
                const employeesResponse = await fetch(`${apiUrl}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employees = await employeesResponse.json();
                
                const today = new Date();
                let expiringCount = 0;
                
                employees.forEach(emp => {
                    if (emp.nationality === 'NON_SAUDI') {
                        const checkExpiry = (dateStr) => {
                            if (!dateStr) return false;
                            const days = Math.floor((new Date(dateStr) - today) / (1000 * 60 * 60 * 24));
                            return days <= 90; // Expiring within 90 days or already expired
                        };
                        
                        if (checkExpiry(emp.passportExpiryDate) || 
                            checkExpiry(emp.workPermitExpiryDate) || 
                            checkExpiry(emp.medicalInsuranceExpiryDate)) {
                            expiringCount++;
                        }
                    }
                });
                
                document.getElementById('expiringDocuments').textContent = expiringCount;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        let isLoadingEmployees = false;
        
        // Toggle Non-Saudi Fields
        function toggleNonSaudiFields() {
            const nationality = document.getElementById('nationality').value;
            const nonSaudiFields = document.getElementById('nonSaudiFields');
            
            if (nationality === 'NON_SAUDI') {
                nonSaudiFields.style.display = 'block';
            } else {
                nonSaudiFields.style.display = 'none';
                // Clear non-Saudi fields when switching to Saudi
                document.getElementById('contractDuration').value = '';
                document.getElementById('contractLeaveDays').value = '';
                document.getElementById('passportNumber').value = '';
                document.getElementById('passportExpiryDate').value = '';
                document.getElementById('workPermitExpiryDate').value = '';
                document.getElementById('passportFeesExpiryDate').value = '';
                document.getElementById('medicalInsuranceExpiryDate').value = '';
            }
        }
        
        async function loadEmployees() {
            if (isLoadingEmployees) {
                console.log('Already loading employees, skipping duplicate call...');
                return;
            }
            
            isLoadingEmployees = true;
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employees = await response.json();
                window.employeesData = employees; // ุญูุธ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
                
                const container = document.getElementById('employeesList');
                if (!employees || employees.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">ูุง ููุฌุฏ ููุธููู</p>';
                    return;
                }

                // ุฃุณูุงุก ุงูุชุฑุฌูุฉ
                const nationalityNames = { 'SAUDI': 'ุณุนูุฏู', 'NON_SAUDI': 'ุบูุฑ ุณุนูุฏู' };
                const workTypeNames = { 'FULL_TIME': 'ุฏูุงู ูุงูู', 'PART_TIME': 'ุฏูุงู ุฌุฒุฆู', 'REMOTE': 'ุนู ุจุนุฏ', 'CONTRACT': 'ุนูุฏ ูุคูุช' };
                const sponsorshipNames = { 'COMPANY': 'ุงูุดุฑูุฉ', 'PERSONAL': 'ุดุฎุตูุฉ', 'EXTERNAL': 'ุฎุงุฑุฌูุฉ' };
                const ticketClassNames = { 'ECONOMY': 'ุงูุชุตุงุฏูุฉ', 'BUSINESS': 'ุฃุนูุงู' };
                const terminationReasonNames = { 'NORMAL_END': 'ุงูุชูุงุก ุทุจูุนู', 'RESIGNATION': 'ุงุณุชูุงูุฉ', 'TERMINATION': 'ุฅููุงุก' };

                container.innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-right: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">๐ ููุงุญุธุฉ: ุญุณุงุจ ุงูุจุฏูุงุช ุญุณุจ ูุงููู ุงูุนูู ุงูุณุนูุฏู</h4>
                        <p style="color: #666; font-size: 14px; margin: 5px 0;">
                            ๐ <strong>ุจุฏู ุงูุณูู:</strong> 25% ูู ุงูุฑุงุชุจ ุงูุฃุณุงุณู (ูู ุญุงู ุนุฏู ุฅุฏุฎุงู ูููุฉ ูุญุฏุฏุฉ)
                        </p>
                        <p style="color: #666; font-size: 14px; margin: 5px 0;">
                            ๐ <strong>ุจุฏู ุงูููู:</strong> 10% ูู ุงูุฑุงุชุจ ุงูุฃุณุงุณู (ูู ุญุงู ุนุฏู ุฅุฏุฎุงู ูููุฉ ูุญุฏุฏุฉ)
                        </p>
                        <p style="color: #666; font-size: 14px; margin: 5px 0;">
                            ๐ฐ <strong>ุงูุฑุงุชุจ ุงูุฅุฌูุงูู:</strong> ุงูุฑุงุชุจ ุงูุฃุณุงุณู + ุจุฏู ุงูุณูู + ุจุฏู ุงูููู
                        </p>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ุฑูู ุงูููุธู</th>
                                    <th>ุงูุงุณู ุงููุงูู</th>
                                    <th>ุฑูู ุงููููุฉ</th>
                                    <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                    <th>ุงููุงุชู</th>
                                    <th>ุงููุณู</th>
                                    <th>ุงููุณูู ุงููุธููู</th>
                                    <th>ุชุงุฑูุฎ ุงูุชุนููู</th>
                                    <th>ุงูุฑุงุชุจ ุงูุฃุณุงุณู</th>
                                    <th>ุจุฏู ุงูุณูู</th>
                                    <th>ุจุฏู ุงูููู</th>
                                    <th>ุงูุฅุฌูุงูู</th>
                                    <th>ุงูุฌูุณูุฉ</th>
                                    <th>ููุน ุงูุนูู</th>
                                    <th>ููุน ุงูููุงูุฉ</th>
                                    <th>ุงูุชุฐูุฑุฉ</th>
                                    <th>ุฏุฑุฌุฉ ุงูุชุฐูุฑุฉ</th>
                                    <th>ูุฏุฉ ุงูุนูุฏ</th>
                                    <th>ุฃูุงู ุงูุฅุฌุงุฒุฉ</th>
                                    <th>ุฑูู ุงูุฌูุงุฒ</th>
                                    <th>ุงูุชูุงุก ุงูุฌูุงุฒ</th>
                                    <th>ุงูุชูุงุก ุฑุฎุตุฉ ุงูุนูู</th>
                                    <th>ุงูุชูุงุก ุงูุชุฃููู</th>
                                    <th>ุงูุชูุงุก ุงูุนูุฏ</th>
                                    <th>ุณุจุจ ุงูุชูุงุก ุงูุฎุฏูุฉ</th>
                                    <th>ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฎุฏูุฉ</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employees.map(emp => {
                                    let statusBadge = '';
                                    
                                    // Check for expiring documents for non-Saudi employees
                                    if (emp.nationality === 'NON_SAUDI') {
                                        const today = new Date();
                                        let warnings = [];
                                        
                                        if (emp.passportExpiryDate) {
                                            const days = Math.floor((new Date(emp.passportExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('ุฌูุงุฒ ููุชูู');
                                            else if (days <= 90) warnings.push(`ุฌูุงุฒ (${days}ุฏ)`);
                                        }
                                        
                                        if (emp.workPermitExpiryDate) {
                                            const days = Math.floor((new Date(emp.workPermitExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('ุฑุฎุตุฉ ููุชููุฉ');
                                            else if (days <= 90) warnings.push(`ุฑุฎุตุฉ (${days}ุฏ)`);
                                        }
                                        
                                        if (emp.medicalInsuranceExpiryDate) {
                                            const days = Math.floor((new Date(emp.medicalInsuranceExpiryDate) - today) / (1000 * 60 * 60 * 24));
                                            if (days < 0) warnings.push('ุชุฃููู ููุชูู');
                                            else if (days <= 90) warnings.push(`ุชุฃููู (${days}ุฏ)`);
                                        }
                                        
                                        if (warnings.length > 0) {
                                            statusBadge = `<span style="background: #ff5252; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; display: inline-block;">${warnings.join(', ')}</span>`;
                                        } else {
                                            statusBadge = `<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">โ ุณููู</span>`;
                                        }
                                    } else {
                                        statusBadge = `<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">โ ุณุนูุฏู</span>`;
                                    }
                                    
                                    // ุญุณุงุจ ุงูุฑุงุชุจ ุงูุฅุฌูุงูู ูุน ุงูุจุฏูุงุช ุงูุงูุชุฑุงุถูุฉ ุญุณุจ ูุงููู ุงูุนูู ุงูุณุนูุฏู
                                    const basicSalary = parseFloat(emp.basicSalary) || 0;
                                    const housingAllowance = parseFloat(emp.housingAllowance) || (basicSalary * 0.25); // 25% ุจุฏู ุณูู
                                    const transportAllowance = parseFloat(emp.transportAllowance) || (basicSalary * 0.10); // 10% ุจุฏู ููู
                                    const totalSalary = basicSalary + housingAllowance + transportAllowance;
                                    
                                    // ุญุณุงุจ ุชูุงุตูู ุงูุจุฏูุงุช
                                    const housingCalc = emp.housingAllowance ? 'ูููุฉ ูุญุฏุฏุฉ' : `${basicSalary.toLocaleString('ar-SA')} ร 25%`;
                                    const transportCalc = emp.transportAllowance ? 'ูููุฉ ูุญุฏุฏุฉ' : `${basicSalary.toLocaleString('ar-SA')} ร 10%`;
                                    
                                    return `
                                    <tr>
                                        <td><strong>${emp.employeeNumber}</strong></td>
                                        <td><strong>${emp.fullName}</strong></td>
                                        <td>${emp.nationalId || '-'}</td>
                                        <td>${emp.email || '-'}</td>
                                        <td>${emp.phone || '-'}</td>
                                        <td>${emp.department || '-'}</td>
                                        <td>${emp.jobTitle || '-'}</td>
                                        <td>${emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td style="color: #667eea; font-weight: bold;">${(emp.basicSalary || 0).toLocaleString('ar-SA')}</td>
                                        <td style="color: #4caf50;" title="${housingCalc}">
                                            ${housingAllowance.toLocaleString('ar-SA')}
                                            <div style="font-size: 10px; color: #999; margin-top: 2px;">${housingCalc}</div>
                                        </td>
                                        <td style="color: #ff9800;" title="${transportCalc}">
                                            ${transportAllowance.toLocaleString('ar-SA')}
                                            <div style="font-size: 10px; color: #999; margin-top: 2px;">${transportCalc}</div>
                                        </td>
                                        <td style="background: #f0f4ff; position: relative; cursor: help;" 
                                            title="ุงูุฃุณุงุณู: ${basicSalary.toLocaleString('ar-SA')} + ุจุฏู ุงูุณูู: ${housingAllowance.toLocaleString('ar-SA')} + ุจุฏู ุงูููู: ${transportAllowance.toLocaleString('ar-SA')}">
                                            <strong style="color: #667eea; font-size: 14px;">๐ฐ ${totalSalary.toLocaleString('ar-SA')}</strong>
                                        </td>
                                        <td>${nationalityNames[emp.nationality] || emp.nationality}</td>
                                        <td>${workTypeNames[emp.workType] || emp.workType || '-'}</td>
                                        <td>${sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '-'}</td>
                                        <td>${emp.ticketEntitlement ? 'ูุนู' : 'ูุง'}</td>
                                        <td>${ticketClassNames[emp.ticketClass] || emp.ticketClass || '-'}</td>
                                        <td>${emp.contractDuration || '-'}</td>
                                        <td>${emp.contractLeaveDays || '-'}</td>
                                        <td>${emp.passportNumber || '-'}</td>
                                        <td>${emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${terminationReasonNames[emp.terminationReason] || '-'}</td>
                                        <td>${emp.terminationDate ? new Date(emp.terminationDate).toLocaleDateString('ar-SA') : '-'}</td>
                                        <td>${statusBadge}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                                                <button onclick="editEmployee(${emp.id})" style="background: #4CAF50; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">ุชุนุฏูู</button>
                                                <button onclick="deleteEmployee(${emp.id}, '${emp.fullName}')" style="background: #f44336; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">ุญุฐู</button>
                                            </div>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading employees:', error);
            } finally {
                isLoadingEmployees = false;
            }
        }

        // ุฏูุงู ุฅุธูุงุฑ/ุฅุฎูุงุก ููุณุฎ ูููุฉ ุงููุฑูุฑ
        function togglePassword(elementId, password) {
            const element = document.getElementById(elementId);
            if (element.textContent === 'โขโขโขโขโขโขโขโข') {
                element.innerHTML = '<strong>' + password + '</strong>';
            } else {
                element.innerHTML = '<strong>โขโขโขโขโขโขโขโข</strong>';
            }
        }

        function copyPassword(password) {
            navigator.clipboard.writeText(password).then(() => {
                alert('โ ุชู ูุณุฎ ูููุฉ ุงููุฑูุฑ');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = password;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('โ ุชู ูุณุฎ ูููุฉ ุงููุฑูุฑ');
            });
        }

        async function loadUsers() {
            try {
                const apiUrl = Config.getApiUrl();
                console.log('Fetching users from:', `${apiUrl}/admin/users`);
                
                const response = await fetch(`${apiUrl}/admin/users`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`ุฎุทุฃ ูู ุงูุฎุงุฏู: ${response.status}`);
                }
                
                const users = await response.json();
                console.log('Users loaded:', users);
                
                const container = document.getElementById('usersList');
                if (!users || users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">ูุง ุชูุฌุฏ ูุณุชุฎุฏููู</p>';
                    return;
                }

                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ุงูุฑูู</th>
                                    <th>ุงูุงุณู ุงููุงูู</th>
                                    <th>ุงุณู ุงููุณุชุฎุฏู</th>
                                    <th>ูููุฉ ุงููุฑูุฑ</th>
                                    <th>ุงูุตูุงุญูุฉ</th>
                                    <th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                    <th>ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map((user, index) => {
                                    const roleName = user.role === 'ADMIN' ? 'ูุฏูุฑ ูุธุงู' : 'ููุธู';
                                    const roleColor = user.role === 'ADMIN' ? '#f44336' : '#2196F3';
                                    const statusBadge = user.isActive 
                                        ? '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">ูุดุท</span>'
                                        : '<span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">ูุนุทู</span>';
                                    
                                    const passwordId = 'pwd_' + index;
                                    const actualPassword = user.password || 'โขโขโขโขโขโขโขโข';
                                    
                                    return `
                                    <tr>
                                        <td><strong>${index + 1}</strong></td>
                                        <td><strong>${user.employeeName || '-'}</strong></td>
                                        <td style="font-family: monospace; color: #2196F3;"><strong>${user.username}</strong></td>
                                        <td style="font-family: monospace; background: #fff3e0; padding: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span id="${passwordId}" style="color: #f44336;"><strong>โขโขโขโขโขโขโขโข</strong></span>
                                                <button onclick="togglePassword('${passwordId}', '${actualPassword}')" 
                                                    style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 2px 6px;" 
                                                    title="ุฅุธูุงุฑ/ุฅุฎูุงุก ูููุฉ ุงููุฑูุฑ">
                                                    ๐๏ธ
                                                </button>
                                                <button onclick="copyPassword('${actualPassword}')" 
                                                    style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 2px 6px;" 
                                                    title="ูุณุฎ ูููุฉ ุงููุฑูุฑ">
                                                    ๐
                                                </button>
                                            </div>
                                        </td>
                                        <td><span style="background: ${roleColor}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 11px;"><strong>${roleName}</strong></span></td>
                                        <td>${user.email || '-'}</td>
                                        <td>${statusBadge}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                        <strong>โ๏ธ ุชุนูููุงุช ูุงูุฉ:</strong>
                        <ul style="margin: 10px 0 0 20px; color: #856404;">
                            <li>ุงุญูุธ ูุฐู ุงูุจูุงูุงุช ูู ููุงู ุขูู</li>
                            <li>ูุง ุชุดุงุฑู ูููุงุช ุงููุฑูุฑ ูุน ุฃู ุดุฎุต ุบูุฑ ูุตุฑุญ ูู</li>
                            <li>ูู ุจุชุบููุฑ ูููุงุช ุงููุฑูุฑ ุจุดูู ุฏูุฑู</li>
                            <li>ุชุฃูุฏ ูู ุนุฏู ุงูุชูุงุท ุตูุฑ ููุดุงุดุฉ ุฃู ูุดุงุฑูุชูุง</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading users:', error);
                const errorMsg = error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
                document.getElementById('usersList').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <p style="color: #f44336; font-size: 18px; margin-bottom: 10px;">โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช</p>
                        <p style="color: #666; font-size: 14px;">${errorMsg}</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">ุชุญูู ูู Console ูููุฒูุฏ ูู ุงูุชูุงุตูู</p>
                        <button onclick="loadUsers()" style="margin-top: 20px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                        </button>
                    </div>
                `;
            }
        }

        async function loadPendingLeaves() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/leaves/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const leaves = await response.json();
                
                const container = document.getElementById('leavesList');
                if (!leaves || leaves.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">ูุง ุชูุฌุฏ ุฅุฌุงุฒุงุช ูุนููุฉ</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูููุธู</th>
                                <th>ููุน ุงูุฅุฌุงุฒุฉ</th>
                                <th>ูู ุชุงุฑูุฎ</th>
                                <th>ุฅูู ุชุงุฑูุฎ</th>
                                <th>ุนุฏุฏ ุงูุฃูุงู</th>
                                <th>ุงูุณุจุจ</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${leaves.map(leave => {
                                // ุญุณุงุจ ุนุฏุฏ ุงูุฃูุงู
                                const start = new Date(leave.startDate);
                                const end = new Date(leave.endDate);
                                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                                
                                return `
                                <tr>
                                    <td>${leave.employee?.fullName || 'ุบูุฑ ูุญุฏุฏ'}</td>
                                    <td>${getLeaveTypeName(leave.type || leave.leaveType)}</td>
                                    <td>${start.toLocaleDateString('ar-SA')}</td>
                                    <td>${end.toLocaleDateString('ar-SA')}</td>
                                    <td>${days}</td>
                                    <td>${leave.reason || '-'}</td>
                                    <td>
                                        <button class="action-btn approve-btn" onclick="approveLeave(${leave.id})">ููุงููุฉ</button>
                                        <button class="action-btn reject-btn" onclick="rejectLeave(${leave.id})">ุฑูุถ</button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading leaves:', error);
            }
        }

        async function loadPendingAdvances() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/advances/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const advances = await response.json();
                
                const container = document.getElementById('advancesList');
                if (!advances || advances.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">ูุง ุชูุฌุฏ ุณูู ูุนููุฉ</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูููุธู</th>
                                <th>ุงููุจูุบ</th>
                                <th>ุชุงุฑูุฎ ุงูุทูุจ</th>
                                <th>ุงูุณุจุจ</th>
                                <th>ุงูุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${advances.map(advance => `
                                <tr>
                                    <td>${advance.employee?.fullName || '-'}</td>
                                    <td>${advance.amount} ุฑูุงู</td>
                                    <td>${new Date(advance.requestDate).toLocaleDateString('ar-SA')}</td>
                                    <td>${advance.reason || '-'}</td>
                                    <td>
                                        <button class="action-btn approve-btn" onclick="approveAdvance(${advance.id})">ููุงููุฉ</button>
                                        <button class="action-btn reject-btn" onclick="rejectAdvance(${advance.id})">ุฑูุถ</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading advances:', error);
            }
        }

        // Add Employee Form Handler
        document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = document.getElementById('submitBtn');
            const alert = document.getElementById('addEmployeeAlert');
            submitBtn.disabled = true;
            
            const editId = form.dataset.editId;
            
            const employeeData = {
                fullName: document.getElementById('fullName').value,
                nationalId: document.getElementById('nationalId').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                department: document.getElementById('department').value,
                jobTitle: document.getElementById('jobTitle').value,
                hireDate: document.getElementById('hireDate').value,
                basicSalary: parseFloat(document.getElementById('basicSalary').value),
                housingAllowance: parseFloat(document.getElementById('housingAllowance').value) || 0,
                transportAllowance: parseFloat(document.getElementById('transportAllowance').value) || 0,
                nationality: document.getElementById('nationality').value,
                workType: document.getElementById('workType').value,
                sponsorshipType: document.getElementById('sponsorshipType').value,
                ticketEntitlement: document.getElementById('ticketEntitlement').value === 'true',
                ticketClass: document.getElementById('ticketClass').value
            };
            
            // ุฅุถุงูุฉ ุจูุงูุงุช ุงูููุฒุฑ ูุงูุจุงุณูุฑุฏ ููุท ูู ุญุงูุฉ ุงูุฅุถุงูุฉ ุฃู ุฅุฐุง ุชู ุชุนุจุฆุชูุง ูู ุญุงูุฉ ุงูุชุนุฏูู
            const usernameValue = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!editId) {
                // ูู ุญุงูุฉ ุงูุฅุถุงูุฉ - ุฅุถุงูุฉ ุงูุจูุงูุงุช (ุงูู HTML required ุณูุชุญูู ูููุง)
                employeeData.username = usernameValue;
                employeeData.password = password;
                employeeData.role = role;
            } else {
                // ูู ุญุงูุฉ ุงูุชุนุฏูู - ุฅุถุงูุฉ ุงูุจูุงูุงุช ููุท ุฅุฐุง ุชู ุชุนุจุฆุชูุง
                if (usernameValue) employeeData.username = usernameValue;
                if (password) employeeData.password = password;
                if (role) employeeData.role = role;
            }
            
            // Add non-Saudi fields if applicable
            if (employeeData.nationality === 'NON_SAUDI') {
                const contractDuration = document.getElementById('contractDuration').value;
                const contractLeaveDays = document.getElementById('contractLeaveDays').value;
                const passportNumber = document.getElementById('passportNumber').value;
                const passportExpiryDate = document.getElementById('passportExpiryDate').value;
                const workPermitExpiryDate = document.getElementById('workPermitExpiryDate').value;
                const passportFeesExpiryDate = document.getElementById('passportFeesExpiryDate').value;
                const medicalInsuranceExpiryDate = document.getElementById('medicalInsuranceExpiryDate').value;
                const contractEndDate = document.getElementById('contractEndDate').value;
                
                if (contractDuration) employeeData.contractDuration = parseInt(contractDuration);
                if (contractLeaveDays) employeeData.contractLeaveDays = parseInt(contractLeaveDays);
                if (passportNumber) employeeData.passportNumber = passportNumber;
                if (passportExpiryDate) employeeData.passportExpiryDate = passportExpiryDate;
                if (workPermitExpiryDate) employeeData.workPermitExpiryDate = workPermitExpiryDate;
                if (passportFeesExpiryDate) employeeData.passportFeesExpiryDate = passportFeesExpiryDate;
                if (medicalInsuranceExpiryDate) employeeData.medicalInsuranceExpiryDate = medicalInsuranceExpiryDate;
                if (contractEndDate) employeeData.contractEndDate = contractEndDate;
            }
            
            // Add end of service fields (optional)
            const terminationReason = document.getElementById('terminationReason').value;
            const terminationDate = document.getElementById('terminationDate').value;
            if (terminationReason) employeeData.terminationReason = terminationReason;
            if (terminationDate) employeeData.terminationDate = terminationDate;

            try {
                const apiUrl = Config.getApiUrl();
                const url = editId ? `${apiUrl}/employees/${editId}` : `${apiUrl}/employees`;
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(employeeData)
                });

                const result = await response.json();

                if (response.ok) {
                    if (editId) {
                        alert.textContent = 'ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูููุธู ุจูุฌุงุญ!';
                    } else {
                        // ุนุฑุถ ุจูุงูุงุช ุงูุฏุฎูู ููููุธู ุงูุฌุฏูุฏ
                        const displayUsername = document.getElementById('usernameInput').value;
                        const displayPassword = document.getElementById('userPassword').value;
                        const role = document.getElementById('userRole').value;
                        const roleText = role === 'ADMIN' ? 'ูุฏูุฑ ูุธุงู' : 'ููุธู';
                        alert.innerHTML = `
                            <strong>โ ุชู ุฅุถุงูุฉ ุงูููุธู ุจูุฌุงุญ!</strong><br>
                            <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                                <strong>ุจูุงูุงุช ุงูุฏุฎูู:</strong><br>
                                ๐ค ุงุณู ุงููุณุชุฎุฏู: <strong>${displayUsername}</strong><br>
                                ๐ ูููุฉ ุงููุฑูุฑ: <strong>${displayPassword}</strong><br>
                                ๐ ุงูุตูุงุญูุฉ: <strong>${roleText}</strong>
                            </div>
                            <p style="margin-top: 10px; color: #d32f2f;">โ๏ธ ุงุญูุธ ูุฐู ุงูุจูุงูุงุช ูุณูููุง ููููุธู</p>
                        `;
                    }
                    alert.className = 'alert success';
                    alert.style.display = 'block';
                    
                    form.reset();
                    if (editId) {
                        cancelEdit();
                        switchTab('employees');  // switchTab will call loadEmployees() automatically
                    }
                } else {
                    throw new Error(result.message || 'ูุดู ูู ุญูุธ ุจูุงูุงุช ุงูููุธู');
                }
            } catch (error) {
                alert.textContent = error.message;
                alert.className = 'alert error';
                alert.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                setTimeout(() => { alert.style.display = 'none'; }, 5000);
            }
        });

        async function approveLeave(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูููุงููุฉ ุนูู ูุฐู ุงูุฅุฌุงุฒุฉุ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/leaves/${id}/approve`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingLeaves();
            } catch (error) {
                alert('ุญุฏุซ ุฎุทุฃ ูู ุงูููุงููุฉ ุนูู ุงูุฅุฌุงุฒุฉ');
            }
        }

        async function rejectLeave(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑูุถ ูุฐู ุงูุฅุฌุงุฒุฉุ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/leaves/${id}/reject`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingLeaves();
            } catch (error) {
                alert('ุญุฏุซ ุฎุทุฃ ูู ุฑูุถ ุงูุฅุฌุงุฒุฉ');
            }
        }

        async function approveAdvance(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูููุงููุฉ ุนูู ูุฐู ุงูุณููุฉุ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/advances/${id}/approve`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingAdvances();
            } catch (error) {
                alert('ุญุฏุซ ุฎุทุฃ ูู ุงูููุงููุฉ ุนูู ุงูุณููุฉ');
            }
        }

        async function rejectAdvance(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑูุถ ูุฐู ุงูุณููุฉุ')) return;
            
            try {
                const apiUrl = Config.getApiUrl();
                await fetch(`${apiUrl}/admin/advances/${id}/reject`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPendingAdvances();
            } catch (error) {
                alert('ุญุฏุซ ุฎุทุฃ ูู ุฑูุถ ุงูุณููุฉ');
            }
        }

        function getLeaveTypeName(type) {
            const types = {
                'ANNUAL': 'ุณูููุฉ',
                'annual': 'ุณูููุฉ',
                'SICK': 'ูุฑุถูุฉ',
                'sick': 'ูุฑุถูุฉ',
                'EMERGENCY': 'ุทุงุฑุฆุฉ',
                'emergency': 'ุทุงุฑุฆุฉ',
                'UNPAID': 'ุจุฏูู ุฑุงุชุจ',
                'unpaid': 'ุจุฏูู ุฑุงุชุจ'
            };
            return types[type] || type;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Edit Employee
        async function editEmployee(id) {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employee = await response.json();
                
                // Fill the form with employee data
                document.getElementById('fullName').value = employee.fullName;
                document.getElementById('employeeNumber').value = employee.employeeNumber;
                document.getElementById('nationalId').value = employee.nationalId;
                document.getElementById('email').value = employee.email || '';
                document.getElementById('phone').value = employee.phone || '';
                document.getElementById('department').value = employee.department || '';
                document.getElementById('jobTitle').value = employee.jobTitle || '';
                document.getElementById('hireDate').value = employee.hireDate ? employee.hireDate.split('T')[0] : '';
                document.getElementById('basicSalary').value = employee.basicSalary || '';
                document.getElementById('housingAllowance').value = employee.housingAllowance || '';
                document.getElementById('transportAllowance').value = employee.transportAllowance || '';
                document.getElementById('nationality').value = employee.nationality || '';
                
                // Fill non-Saudi fields if applicable
                if (employee.nationality === 'NON_SAUDI') {
                    document.getElementById('contractDuration').value = employee.contractDuration || '';
                    document.getElementById('contractLeaveDays').value = employee.contractLeaveDays || '';
                    document.getElementById('passportNumber').value = employee.passportNumber || '';
                    document.getElementById('passportExpiryDate').value = employee.passportExpiryDate ? employee.passportExpiryDate.split('T')[0] : '';
                    document.getElementById('workPermitExpiryDate').value = employee.workPermitExpiryDate ? employee.workPermitExpiryDate.split('T')[0] : '';
                    document.getElementById('passportFeesExpiryDate').value = employee.passportFeesExpiryDate ? employee.passportFeesExpiryDate.split('T')[0] : '';
                    document.getElementById('medicalInsuranceExpiryDate').value = employee.medicalInsuranceExpiryDate ? employee.medicalInsuranceExpiryDate.split('T')[0] : '';
                }
                
                // Toggle non-Saudi fields visibility
                toggleNonSaudiFields();
                
                // Change form to edit mode
                const form = document.getElementById('addEmployeeForm');
                form.dataset.editId = id;
                
                // Make username, password, and role optional in edit mode
                document.getElementById('usernameInput').removeAttribute('required');
                document.getElementById('userPassword').removeAttribute('required');
                document.getElementById('userRole').removeAttribute('required');
                
                // Clear these fields and add placeholders
                document.getElementById('usernameInput').value = '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = '';
                document.getElementById('usernameInput').placeholder = 'ุงุชุฑู ูุงุฑุบุงู ููุฅุจูุงุก ุนูู ุงูููุฒุฑ ุงูุญุงูู';
                document.getElementById('userPassword').placeholder = 'ุงุชุฑู ูุงุฑุบุงู ููุฅุจูุงุก ุนูู ุงูุจุงุณูุฑุฏ ุงูุญุงูู';
                
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.textContent = 'ุชุญุฏูุซ ุงูููุธู';
                submitBtn.style.background = '#FF9800';
                
                // Switch to add employee tab
                switchTab('addEmployee');
                
                // Add cancel button if not exists
                if (!document.getElementById('cancelEditBtn')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancelEditBtn';
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'ุฅูุบุงุก ุงูุชุนุฏูู';
                    cancelBtn.style.cssText = 'background: #9e9e9e; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;';
                    cancelBtn.onclick = cancelEdit;
                    submitBtn.parentElement.insertBefore(cancelBtn, submitBtn);
                }
            } catch (error) {
                console.error('Error loading employee:', error);
                alert('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูููุธู: ' + (error.message || 'ุชุฃูุฏ ูู ุงุชุตุงู ุงูุณูุฑูุฑ'));
            }
        }

        // Cancel Edit
        function cancelEdit() {
            const form = document.getElementById('addEmployeeForm');
            form.reset();
            delete form.dataset.editId;
            
            // Restore required attributes
            document.getElementById('usernameInput').setAttribute('required', 'required');
            document.getElementById('userPassword').setAttribute('required', 'required');
            document.getElementById('userRole').setAttribute('required', 'required');
            
            // Restore original placeholders
            document.getElementById('usernameInput').placeholder = 'ุงุณู ุงููุณุชุฎุฏู ููุฏุฎูู ูููุธุงู';
            document.getElementById('userPassword').placeholder = 'ูููุฉ ุงููุฑูุฑ ููุฏุฎูู';
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'ุฅุถุงูุฉ ุงูููุธู';
            submitBtn.style.background = '';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.remove();
        }

        // Delete Employee
        async function deleteEmployee(id, name) {
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุธู: ${name}ุ`)) {
                return;
            }
            
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/employees/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('ุชู ุญุฐู ุงูููุธู ุจูุฌุงุญ');
                    loadEmployees();
                } else {
                    const error = await response.json();
                    alert(error.message || 'ุฎุทุฃ ูู ุญุฐู ุงูููุธู');
                }
            } catch (error) {
                alert('ุฎุทุฃ ูู ุญุฐู ุงูููุธู');
                console.error('Error deleting employee:', error);
            }
        }

        // Resend Activation Email
        async function resendActivationEmail(employeeId, employeeName) {
            if (!confirm(`ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุจุฑูุฏ ุงูุชูุนูู ููููุธู: ${employeeName}ุ\n\nุณูุชู ุฅูุดุงุก ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ ูุฅุฑุณุงููุง ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู.`)) {
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'โณ ุฌุงุฑู ุงูุฅุฑุณุงู...';
            button.disabled = true;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/admin/employees/${employeeId}/resend-activation`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`โ ุชู ุฅุฑุณุงู ุจุฑูุฏ ุงูุชูุนูู ุจูุฌุงุญ ุฅูู:\n${result.email}\n\nุงุณู ุงููุณุชุฎุฏู: ${result.username}`);
                } else {
                    const error = await response.json();
                    alert(`โ ${error.message || 'ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู'}`);
                }
            } catch (error) {
                alert('โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู');
                console.error('Error resending activation email:', error);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Settings Functions
        let departments = [];
        let jobTitles = [];

        async function loadSettings() {
            await Promise.all([
                loadCompanySettings(),
                loadDepartments(),
                loadJobTitles()
            ]);
            await loadDepartmentsAndJobTitlesForForm();
        }

        async function loadCompanySettings() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/company`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const settings = await response.json();
                
                if (settings) {
                    document.getElementById('companyName').value = settings.companyName || '';
                    document.getElementById('companyNameEn').value = settings.companyNameEn || '';
                    document.getElementById('companyEmail').value = settings.email || '';
                    document.getElementById('companyPhone').value = settings.phone || '';
                    document.getElementById('companyAddress').value = settings.address || '';
                    document.getElementById('taxNumber').value = settings.taxNumber || '';
                    
                    // Load logo if exists
                    if (settings.logo) {
                        displayLogo(settings.logo);
                    }
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        }

        // Logo Management Functions
        let currentLogo = null;

        function displayLogo(logoData) {
            currentLogo = logoData;
            const logoImage = document.getElementById('logoImage');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            
            if (logoData) {
                logoImage.src = logoData;
                logoImage.style.display = 'block';
                logoPlaceholder.style.display = 'none';
            } else {
                logoImage.style.display = 'none';
                logoPlaceholder.style.display = 'block';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.match('image/(png|jpeg|jpg)')) {
                alert('ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุจุตูุบุฉ PNG ุฃู JPG');
                return;
            }

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃู ูุง ูุชุฌุงูุฒ 2 ููุฌุงุจุงูุช');
                return;
            }

            // Read and display the image
            const reader = new FileReader();
            reader.onload = function(e) {
                displayLogo(e.target.result);
                // Auto-save logo
                saveLogo(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        async function saveLogo(logoData) {
            try {
                const apiUrl = Config.getApiUrl();
                const settings = {
                    companyName: document.getElementById('companyName').value,
                    companyNameEn: document.getElementById('companyNameEn').value,
                    email: document.getElementById('companyEmail').value,
                    phone: document.getElementById('companyPhone').value,
                    address: document.getElementById('companyAddress').value,
                    taxNumber: document.getElementById('taxNumber').value,
                    logo: logoData
                };

                const response = await fetch(`${apiUrl}/settings/company`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('ุชู ุญูุธ ุดุนุงุฑ ุงูุดุฑูุฉ ุจูุฌุงุญ! โ');
                } else {
                    throw new Error('ูุดู ูู ุญูุธ ุงูุดุนุงุฑ');
                }
            } catch (error) {
                alert('ุฎุทุฃ ูู ุญูุธ ุดุนุงุฑ ุงูุดุฑูุฉ: ' + error.message);
                console.error('Error saving logo:', error);
            }
        }

        function removeLogo() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุดุนุงุฑ ุงูุดุฑูุฉุ')) return;
            
            displayLogo(null);
            saveLogo(null);
        }

        async function loadDepartments() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/departments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                departments = await response.json();
                displayDepartments();
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadJobTitles() {
            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/job-titles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                jobTitles = await response.json();
                displayJobTitles();
            } catch (error) {
                console.error('Error loading job titles:', error);
            }
        }

        function displayDepartments() {
            const container = document.getElementById('departmentsList');
            if (!departments || departments.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 10px;">ูุง ุชูุฌุฏ ุฃูุณุงู</p>';
                return;
            }

            container.innerHTML = departments.map(dept => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px;">
                    <span style="font-weight: 500;">${dept.name}</span>
                    <button onclick="deleteDepartment(${dept.id})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ุญุฐู</button>
                </div>
            `).join('');
        }

        function displayJobTitles() {
            const container = document.getElementById('jobTitlesList');
            if (!jobTitles || jobTitles.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 10px;">ูุง ุชูุฌุฏ ูุณููุงุช ูุธูููุฉ</p>';
                return;
            }

            container.innerHTML = jobTitles.map(title => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 6px;">
                    <span style="font-weight: 500;">${title.title}</span>
                    <button onclick="deleteJobTitle(${title.id})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ุญุฐู</button>
                </div>
            `).join('');
        }

        async function addDepartment() {
            const input = document.getElementById('newDepartment');
            const name = input.value.trim();
            
            if (!name) {
                alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุณู');
                return;
            }

            try {
                const apiUrl = Config.getApiUrl();
                console.log('Sending department:', { name });
                const response = await fetch(`${apiUrl}/settings/departments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    input.value = '';
                    await loadDepartments();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ุชู ุฅุถุงูุฉ ุงููุณู ุจูุฌุงุญ');
                } else {
                    alert(`ูุดู ูู ุฅุถุงูุฉ ุงููุณู: ${result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                }
            } catch (error) {
                alert(`ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุณู: ${error.message}`);
                console.error('Error adding department:', error);
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณูุ')) return;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/departments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadDepartments();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ุชู ุญุฐู ุงููุณู ุจูุฌุงุญ');
                } else {
                    alert('ูุดู ูู ุญุฐู ุงููุณู');
                }
            } catch (error) {
                alert('ุฎุทุฃ ูู ุญุฐู ุงููุณู');
                console.error('Error deleting department:', error);
            }
        }

        async function addJobTitle() {
            const input = document.getElementById('newJobTitle');
            const title = input.value.trim();
            
            if (!title) {
                alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงููุณูู ุงููุธููู');
                return;
            }

            try {
                const apiUrl = Config.getApiUrl();
                console.log('Sending job title:', { title });
                const response = await fetch(`${apiUrl}/settings/job-titles`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    input.value = '';
                    await loadJobTitles();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ุชู ุฅุถุงูุฉ ุงููุณูู ุงููุธููู ุจูุฌุงุญ');
                } else {
                    alert(`ูุดู ูู ุฅุถุงูุฉ ุงููุณูู ุงููุธููู: ${result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'}`);
                }
            } catch (error) {
                alert(`ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุณูู ุงููุธููู: ${error.message}`);
                console.error('Error adding job title:', error);
            }
        }

        async function deleteJobTitle(id) {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณูู ุงููุธูููุ')) return;

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/job-titles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadJobTitles();
                    await loadDepartmentsAndJobTitlesForForm();
                    alert('ุชู ุญุฐู ุงููุณูู ุงููุธููู ุจูุฌุงุญ');
                } else {
                    alert('ูุดู ูู ุญุฐู ุงููุณูู ุงููุธููู');
                }
            } catch (error) {
                alert('ุฎุทุฃ ูู ุญุฐู ุงููุณูู ุงููุธููู');
                console.error('Error deleting job title:', error);
            }
        }

        async function loadDepartmentsAndJobTitlesForForm() {
            const apiUrl = Config.getApiUrl();
            const deptSelect = document.getElementById('department');
            const jobSelect = document.getElementById('jobTitle');

            // Load departments
            const deptsResponse = await fetch(`${apiUrl}/settings/departments`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const depts = await deptsResponse.json();
            
            deptSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุณู --</option>' +
                depts.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

            // Load job titles
            const jobsResponse = await fetch(`${apiUrl}/settings/job-titles`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const jobs = await jobsResponse.json();
            
            jobSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุณูู ุงููุธููู --</option>' +
                jobs.map(j => `<option value="${j.title}">${j.title}</option>`).join('');
        }

        // Company Settings Form
        document.getElementById('companySettingsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                companyName: document.getElementById('companyName').value,
                companyNameEn: document.getElementById('companyNameEn').value,
                email: document.getElementById('companyEmail').value,
                phone: document.getElementById('companyPhone').value,
                address: document.getElementById('companyAddress').value,
                taxNumber: document.getElementById('taxNumber').value,
            };

            try {
                const apiUrl = Config.getApiUrl();
                const response = await fetch(`${apiUrl}/settings/company`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุดุฑูุฉ ุจูุฌุงุญ');
                } else {
                    alert('ูุดู ูู ุญูุธ ุงูุฅุนุฏุงุฏุงุช');
                }
            } catch (error) {
                alert('ุฎุทุฃ ูู ุญูุธ ุงูุฅุนุฏุงุฏุงุช');
                console.error('Error saving settings:', error);
            }
        });

        // Load initial dashboard data and form options
        loadDashboard();
        loadDepartmentsAndJobTitlesForForm();
        
        // ============= EXPORT FUNCTIONS =============
        
        function exportToExcel() {
            if (!window.employeesData || window.employeesData.length === 0) {
                alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
                return;
            }
            
            const nationalityNames = { 'SAUDI': 'ุณุนูุฏู', 'NON_SAUDI': 'ุบูุฑ ุณุนูุฏู' };
            const workTypeNames = { 'FULL_TIME': 'ุฏูุงู ูุงูู', 'PART_TIME': 'ุฏูุงู ุฌุฒุฆู', 'REMOTE': 'ุนู ุจุนุฏ', 'CONTRACT': 'ุนูุฏ ูุคูุช' };
            const sponsorshipNames = { 'COMPANY': 'ุงูุดุฑูุฉ', 'PERSONAL': 'ุดุฎุตูุฉ', 'EXTERNAL': 'ุฎุงุฑุฌูุฉ' };
            const ticketClassNames = { 'ECONOMY': 'ุงูุชุตุงุฏูุฉ', 'BUSINESS': 'ุฃุนูุงู' };
            const terminationReasonNames = { 'NORMAL_END': 'ุงูุชูุงุก ุทุจูุนู', 'RESIGNATION': 'ุงุณุชูุงูุฉ', 'TERMINATION': 'ุฅููุงุก' };
            
            // ุชุญุถูุฑ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
            const exportData = window.employeesData.map(emp => {
                const totalSalary = (parseFloat(emp.basicSalary) || 0) + (parseFloat(emp.housingAllowance) || 0) + (parseFloat(emp.transportAllowance) || 0);
                
                return {
                    'ุฑูู ุงูููุธู': emp.employeeNumber,
                    'ุงูุงุณู ุงููุงูู': emp.fullName,
                    'ุฑูู ุงููููุฉ': emp.nationalId || '',
                    'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู': emp.email || '',
                    'ุงููุงุชู': emp.phone || '',
                    'ุงููุณู': emp.department || '',
                    'ุงููุณูู ุงููุธููู': emp.jobTitle || '',
                    'ุชุงุฑูุฎ ุงูุชุนููู': emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '',
                    'ุงูุฑุงุชุจ ุงูุฃุณุงุณู': emp.basicSalary || 0,
                    'ุจุฏู ุงูุณูู': emp.housingAllowance || 0,
                    'ุจุฏู ุงูููู': emp.transportAllowance || 0,
                    'ุฅุฌูุงูู ุงูุฑุงุชุจ': totalSalary,
                    'ุงูุฌูุณูุฉ': nationalityNames[emp.nationality] || emp.nationality,
                    'ููุน ุงูุนูู': workTypeNames[emp.workType] || emp.workType || '',
                    'ููุน ุงูููุงูุฉ': sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '',
                    'ุงุณุชุญูุงู ุงูุชุฐูุฑุฉ': emp.ticketEntitlement ? 'ูุนู' : 'ูุง',
                    'ุฏุฑุฌุฉ ุงูุชุฐูุฑุฉ': ticketClassNames[emp.ticketClass] || emp.ticketClass || '',
                    'ูุฏุฉ ุงูุนูุฏ (ุดููุฑ)': emp.contractDuration || '',
                    'ุฃูุงู ุงูุฅุฌุงุฒุฉ': emp.contractLeaveDays || '',
                    'ุฑูู ุงูุฌูุงุฒ': emp.passportNumber || '',
                    'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฌูุงุฒ': emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ุชุงุฑูุฎ ุงูุชูุงุก ุฑุฎุตุฉ ุงูุนูู': emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุชุฃููู ุงูุทุจู': emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '',
                    'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ': emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '',
                    'ุณุจุจ ุงูุชูุงุก ุงูุฎุฏูุฉ': terminationReasonNames[emp.terminationReason] || '',
                    'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฎุฏูุฉ': emp.terminationDate ? new Date(emp.terminationDate).toLocaleDateString('ar-SA') : ''
                };
            });
            
            // ุฅูุดุงุก ููู Excel
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ุงูููุธููู');
            
            // ุชูุฒูู ุงูููู
            const fileName = `ูุงุฆูุฉ_ุงูููุธููู_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function exportToPDF() {
            if (!window.employeesData || window.employeesData.length === 0) {
                alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            const nationalityNames = { 'SAUDI': 'ุณุนูุฏู', 'NON_SAUDI': 'ุบูุฑ ุณุนูุฏู' };
            const workTypeNames = { 'FULL_TIME': 'ุฏูุงู ูุงูู', 'PART_TIME': 'ุฏูุงู ุฌุฒุฆู', 'REMOTE': 'ุนู ุจุนุฏ', 'CONTRACT': 'ุนูุฏ ูุคูุช' };
            const sponsorshipNames = { 'COMPANY': 'ุงูุดุฑูุฉ', 'PERSONAL': 'ุดุฎุตูุฉ', 'EXTERNAL': 'ุฎุงุฑุฌูุฉ' };
            
            // ุนููุงู ุงูุชูุฑูุฑ
            doc.setFontSize(16);
            doc.text('ูุงุฆูุฉ ุงูููุธููู', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
            
            // ุชุญุถูุฑ ุงูุจูุงูุงุช ููุฌุฏูู - ุตูุญุฉ 1: ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
            const tableData1 = window.employeesData.map(emp => {
                const totalSalary = (parseFloat(emp.basicSalary) || 0) + (parseFloat(emp.housingAllowance) || 0) + (parseFloat(emp.transportAllowance) || 0);
                return [
                    emp.employeeNumber,
                    emp.fullName,
                    emp.nationalId || '-',
                    emp.email || '-',
                    emp.phone || '-',
                    emp.department || '-',
                    emp.jobTitle || '-',
                    emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ar-SA') : '-',
                    emp.basicSalary || 0,
                    emp.housingAllowance || 0,
                    emp.transportAllowance || 0,
                    totalSalary.toFixed(2)
                ];
            });
            
            doc.autoTable({
                startY: 28,
                head: [['ุฑูู ุงูููุธู', 'ุงูุงุณู', 'ุฑูู ุงููููุฉ', 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู', 'ุงููุงุชู', 'ุงููุณู', 'ุงููุธููุฉ', 'ุชุงุฑูุฎ ุงูุชุนููู', 'ุงูุฃุณุงุณู', 'ุงูุณูู', 'ุงูููู', 'ุงูุฅุฌูุงูู']],
                body: tableData1,
                styles: { 
                    font: 'helvetica',
                    fontSize: 7,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: 255,
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { top: 28, left: 5, right: 5 }
            });
            
            // ุตูุญุฉ 2: ูุนูููุงุช ุฅุถุงููุฉ
            doc.addPage();
            doc.setFontSize(14);
            doc.text('ูุนูููุงุช ุฅุถุงููุฉ ููููุธููู', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            
            const tableData2 = window.employeesData.map(emp => [
                emp.employeeNumber,
                emp.fullName,
                nationalityNames[emp.nationality] || emp.nationality,
                workTypeNames[emp.workType] || emp.workType || '-',
                sponsorshipNames[emp.sponsorshipType] || emp.sponsorshipType || '-',
                emp.ticketEntitlement ? 'ูุนู' : 'ูุง',
                emp.contractDuration || '-',
                emp.contractLeaveDays || '-'
            ]);
            
            doc.autoTable({
                startY: 22,
                head: [['ุฑูู ุงูููุธู', 'ุงูุงุณู', 'ุงูุฌูุณูุฉ', 'ููุน ุงูุนูู', 'ุงูููุงูุฉ', 'ุงูุชุฐูุฑุฉ', 'ูุฏุฉ ุงูุนูุฏ', 'ุฃูุงู ุงูุฅุฌุงุฒุฉ']],
                body: tableData2,
                styles: { 
                    font: 'helvetica',
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { left: 5, right: 5 }
            });
            
            // ุตูุญุฉ 3: ูุนูููุงุช ุงูููุธููู ุบูุฑ ุงูุณุนูุฏููู
            const nonSaudiEmployees = window.employeesData.filter(emp => emp.nationality === 'NON_SAUDI');
            if (nonSaudiEmployees.length > 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text('ูุนูููุงุช ุงูููุธููู ุบูุฑ ุงูุณุนูุฏููู', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                
                const tableData3 = nonSaudiEmployees.map(emp => [
                    emp.employeeNumber,
                    emp.fullName,
                    emp.passportNumber || '-',
                    emp.passportExpiryDate ? new Date(emp.passportExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.workPermitExpiryDate ? new Date(emp.workPermitExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.medicalInsuranceExpiryDate ? new Date(emp.medicalInsuranceExpiryDate).toLocaleDateString('ar-SA') : '-',
                    emp.contractEndDate ? new Date(emp.contractEndDate).toLocaleDateString('ar-SA') : '-'
                ]);
                
                doc.autoTable({
                    startY: 22,
                    head: [['ุฑูู ุงูููุธู', 'ุงูุงุณู', 'ุฑูู ุงูุฌูุงุฒ', 'ุงูุชูุงุก ุงูุฌูุงุฒ', 'ุงูุชูุงุก ุฑุฎุตุฉ ุงูุนูู', 'ุงูุชูุงุก ุงูุชุฃููู', 'ุงูุชูุงุก ุงูุนูุฏ']],
                    body: tableData3,
                    styles: { 
                        font: 'helvetica',
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { left: 5, right: 5 }
                });
            }
            
            // ุญูุธ ุงูููู
            const fileName = `ูุงุฆูุฉ_ุงูููุธููู_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Excel Upload Functions
        let excelData = [];

        function downloadExcelTemplate() {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Define template headers
            const headers = [
                'ุงูุงุณู ุงููุงูู*',
                'ุฑูู ุงููููุฉ*',
                'ุงุณู ุงููุณุชุฎุฏู*',
                'ูููุฉ ุงููุฑูุฑ*',
                'ุงูุตูุงุญูุฉ* (EMPLOYEE ุงู ADMIN)',
                'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
                'ุฑูู ุงูุฌูุงู',
                'ุงููุณู*',
                'ุงููุณูู ุงููุธููู*',
                'ุชุงุฑูุฎ ุงูุชุนููู* (YYYY-MM-DD)',
                'ุงูุฑุงุชุจ ุงูุฃุณุงุณู*',
                'ุจุฏู ุงูุณูู',
                'ุจุฏู ุงูููู',
                'ุงูุฌูุณูุฉ (SAUDI ุงู NON_SAUDI)',
                'ููุน ุงูุนูู (FULL_TIME, PART_TIME, REMOTE, CONTRACT)',
                'ูุฏุฉ ุงูุนูุฏ (ุจุงูุฃุดูุฑ)',
                'ุนุฏุฏ ุฃูุงู ุงูุฅุฌุงุฒุฉ ุจุงูุนูุฏ',
                'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ (YYYY-MM-DD)',
                'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุชุฃููู ุงูุทุจู (YYYY-MM-DD)',
                'ููุน ุงูููุงูุฉ (COMPANY, PERSONAL, EXTERNAL)',
                'ุงุณุชุญูุงู ุงูุชุฐูุฑุฉ (true ุงู false)',
                'ุฏุฑุฌุฉ ุงูุชุฐูุฑุฉ (ECONOMY ุงู BUSINESS)',
                'ุฑูู ุงูุฌูุงุฒ',
                'ุชุงุฑูุฎ ุงูุชูุงุก ุงูุฌูุงุฒ (YYYY-MM-DD)',
                'ุชุงุฑูุฎ ุงูุชูุงุก ุฑุฎุตุฉ ุงูุนูู (YYYY-MM-DD)',
                'ุชุงุฑูุฎ ุงูุชูุงุก ุฑุณูู ุงูุฌูุงุฒุงุช (YYYY-MM-DD)'
            ];
            
            // Sample data row
            const sampleData = [
                'ุฃุญูุฏ ูุญูุฏ ุนูู',
                '1234567890',
                'ahmed.ali',
                'Pass@123',
                'EMPLOYEE',
                'ahmed@example.com',
                '0501234567',
                'ุชูููุฉ ุงููุนูููุงุช',
                'ูุจุฑูุฌ',
                '2024-01-15',
                '8000',
                '2000',
                '1000',
                'SAUDI',
                'FULL_TIME',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                ''
            ];
            
            // Create worksheet data
            const wsData = [headers, sampleData];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = headers.map(() => ({ wch: 20 }));
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'ูุงูุจ ุงูููุธููู');
            
            // Download the file
            XLSX.writeFile(wb, 'ูุงูุจ_ุฅุถุงูุฉ_ููุธููู.xlsx');
            
            showAlert('excelUploadAlert', 'ุชู ุชุญููู ูุงูุจ Excel ุจูุฌุงุญ! ูู ุจููุก ุงูุจูุงูุงุช ูุฑูุน ุงูููู ูุฑุฉ ุฃุฎุฑู.', 'success');
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('excelFileName').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showAlert('excelUploadAlert', 'ุงูููู ูุงุฑุบ ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช!', 'error');
                        return;
                    }
                    
                    // Parse data
                    const headers = jsonData[0];
                    excelData = [];
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0 || !row[0]) continue; // Skip empty rows
                        
                        const employee = {
                            fullName: row[0] || '',
                            nationalId: row[1] || '',
                            username: row[2] || '',
                            password: row[3] || '',
                            role: row[4] || 'EMPLOYEE',
                            email: row[5] || '',
                            phone: row[6] || '',
                            department: row[7] || '',
                            jobTitle: row[8] || '',
                            hireDate: row[9] || '',
                            basicSalary: parseFloat(row[10]) || 0,
                            housingAllowance: parseFloat(row[11]) || 0,
                            transportAllowance: parseFloat(row[12]) || 0,
                            nationality: row[13] || 'SAUDI',
                            workType: row[14] || 'FULL_TIME',
                            contractDuration: row[15] ? parseInt(row[15]) : null,
                            contractLeaveDays: row[16] ? parseInt(row[16]) : null,
                            contractEndDate: row[17] || null,
                            medicalInsuranceExpiryDate: row[18] || null,
                            sponsorshipType: row[19] || null,
                            ticketEntitlement: row[20] === 'true' || row[20] === true,
                            ticketClass: row[21] || null,
                            passportNumber: row[22] || null,
                            passportExpiryDate: row[23] || null,
                            workPermitExpiryDate: row[24] || null,
                            passportFeesExpiryDate: row[25] || null
                        };
                        
                        excelData.push(employee);
                    }
                    
                    displayExcelPreview();
                    showAlert('excelUploadAlert', `ุชู ูุฑุงุกุฉ ${excelData.length} ููุธู ูู ุงูููู. ุฑุงุฌุน ุงูุจูุงูุงุช ูุจู ุงูุญูุธ.`, 'success');
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showAlert('excelUploadAlert', 'ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู! ุชุฃูุฏ ูู ุฃู ุงูููู ุจุตูุบุฉ ุตุญูุญุฉ.', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayExcelPreview() {
            const previewDiv = document.getElementById('excelPreview');
            const headerDiv = document.getElementById('excelPreviewHeader');
            const bodyDiv = document.getElementById('excelPreviewBody');
            
            // Show preview
            previewDiv.style.display = 'block';
            
            // Create table header
            headerDiv.innerHTML = `
                <tr style="background: #2e7d32; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">#</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุงูุงุณู</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุฑูู ุงููููุฉ</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุงุณู ุงููุณุชุฎุฏู</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุงููุณู</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุงููุณูู ุงููุธููู</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุงูุฑุงุชุจ</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ุชุงุฑูุฎ ุงูุชุนููู</th>
                </tr>
            `;
            
            // Create table body
            bodyDiv.innerHTML = excelData.map((emp, index) => `
                <tr style="background: ${index % 2 === 0 ? 'white' : '#f5f5f5'};">
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.fullName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.nationalId}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.username}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.department}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.jobTitle}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.basicSalary}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${emp.hireDate}</td>
                </tr>
            `).join('');
        }

        async function uploadEmployeesFromExcel() {
            if (excelData.length === 0) {
                showAlert('excelUploadAlert', 'ูุง ุชูุฌุฏ ุจูุงูุงุช ููุญูุธ!', 'error');
                return;
            }
            
            const confirmMsg = `ูู ุฃูุช ูุชุฃูุฏ ูู ุฑูุน ${excelData.length} ููุธู ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ`;
            if (!confirm(confirmMsg)) return;
            
            try {
                showAlert('excelUploadAlert', 'ุฌุงุฑู ุญูุธ ุงูููุธููู...', 'info');
                
                const response = await fetch(`${API_URL}/employees/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ employees: excelData })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('excelUploadAlert', 
                        `โ ุชู ุฅุถุงูุฉ ${result.successCount} ููุธู ุจูุฌุงุญ!${result.failedCount > 0 ? ` (ูุดู: ${result.failedCount})` : ''}`, 
                        'success'
                    );
                    
                    // Reset and reload
                    cancelExcelUpload();
                    loadEmployees();
                    
                    // Show details if any failures
                    if (result.errors && result.errors.length > 0) {
                        console.error('Errors:', result.errors);
                        setTimeout(() => {
                            alert('ุชูุงุตูู ุงูุฃุฎุทุงุก:\n' + result.errors.map(e => `- ${e.employee}: ${e.error}`).join('\n'));
                        }, 1000);
                    }
                } else {
                    showAlert('excelUploadAlert', result.message || 'ูุดู ูู ุญูุธ ุงูููุธููู!', 'error');
                }
                
            } catch (error) {
                console.error('Error uploading employees:', error);
                showAlert('excelUploadAlert', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุน ุงูููุธููู!', 'error');
            }
        }

        function cancelExcelUpload() {
            excelData = [];
            document.getElementById('excelFile').value = '';
            document.getElementById('excelFileName').textContent = '';
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelUploadAlert').innerHTML = '';
        }
        
        // =============== Backup Functions ===============
        
        // Load backup info when switching to backup tab
        async function loadBackupInfo() {
            try {
                const response = await fetch(`${apiUrl}/backup/info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Display stats
                    const statsHtml = `
                        <div style="display: grid; gap: 8px;">
                            <div>๐ฅ ุงูููุธููู: <strong>${data.currentData.employees}</strong></div>
                            <div>๐ ุงููุณุชุฎุฏููู: <strong>${data.currentData.users}</strong></div>
                            <div>๐ ุงูุฅุฌุงุฒุงุช: <strong>${data.currentData.leaves}</strong></div>
                            <div>๐ฐ ุงูุณูู: <strong>${data.currentData.advances}</strong></div>
                            <div>๐ฆ ุงูุนูุฏ: <strong>${data.currentData.assets}</strong></div>
                            <div>โฐ ุณุฌูุงุช ุงูุญุถูุฑ: <strong>${data.currentData.attendances}</strong></div>
                            <div>๐ต ุณุฌูุงุช ุงูุฑูุงุชุจ: <strong>${data.currentData.payrollRecords}</strong></div>
                        </div>
                    `;
                    document.getElementById('backupStats').innerHTML = statsHtml;
                    
                    // Display last saved time
                    if (data.lastSaved) {
                        const date = new Date(data.lastSaved);
                        document.getElementById('lastSaved').innerHTML = `
                            <div style="font-size: 16px; color: #4caf50; font-weight: bold; margin-bottom: 5px;">
                                ${date.toLocaleDateString('ar-SA')}
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                ${date.toLocaleTimeString('ar-SA')}
                            </div>
                        `;
                    } else {
                        document.getElementById('lastSaved').innerHTML = '<span style="color: #999;">ุบูุฑ ูุชููุฑ</span>';
                    }
                }
            } catch (error) {
                console.error('Error loading backup info:', error);
            }
        }
        
        // Download backup
        async function downloadBackup() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'โณ ุฌุงุฑู ุงูุชุญููู...';
                
                const response = await fetch(`${apiUrl}/backup/download`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('ูุดู ูู ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hr-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('โ ุชู ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!');
                
            } catch (error) {
                console.error('Error downloading backup:', error);
                alert('โ ูุดู ูู ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: ' + error.message);
            } finally {
                const btn = event.target;
                btn.disabled = false;
                btn.textContent = '๐ฅ ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ';
            }
        }
        
        // Handle backup file selection
        async function handleBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุชุ ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ!')) {
                try {
                    const text = await file.text();
                    const backupData = JSON.parse(text);
                    
                    // Validate backup structure
                    if (!backupData.data) {
                        throw new Error('ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุญูุญ');
                    }
                    
                    // Show confirmation with stats
                    const stats = backupData.stats || {};
                    const confirmMsg = `
ูู ุชุฑูุฏ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงูุชุงููุฉุ

๐ฅ ุงูููุธููู: ${stats.employees || 0}
๐ ุงููุณุชุฎุฏููู: ${stats.users || 0}
๐ ุงูุฅุฌุงุฒุงุช: ${stats.leaves || 0}
๐ฐ ุงูุณูู: ${stats.advances || 0}
๐ฆ ุงูุนูุฏ: ${stats.assets || 0}
โฐ ุณุฌูุงุช ุงูุญุถูุฑ: ${stats.attendances || 0}

โ๏ธ ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ!
                    `.trim();
                    
                    if (!confirm(confirmMsg)) {
                        event.target.value = '';
                        return;
                    }
                    
                    // Restore backup
                    const response = await fetch(`${apiUrl}/backup/restore`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(backupData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!\n\nุณูุชู ุชุญุฏูุซ ุงูุตูุญุฉ ุงูุขู...');
                        location.reload();
                    } else {
                        throw new Error(result.message || 'ูุดู ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช');
                    }
                    
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    alert('โ ูุดู ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช: ' + error.message);
                } finally {
                    event.target.value = '';
                }
            } else {
                event.target.value = '';
            }
        }
        
        // Manual save
        async function manualSave() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'โณ ุฌุงุฑู ุงูุญูุธ...';
                
                const response = await fetch(`${apiUrl}/backup/auto-save`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('โ ุชู ุงูุญูุธ ุจูุฌุงุญ!');
                    loadBackupInfo(); // Refresh info
                } else {
                    throw new Error(result.message || 'ูุดู ูู ุงูุญูุธ');
                }
                
            } catch (error) {
                console.error('Error saving:', error);
                alert('โ ูุดู ูู ุงูุญูุธ: ' + error.message);
            } finally {
                const btn = event.target;
                btn.disabled = false;
                btn.textContent = '๐พ ุญูุธ ุงูุขู';
            }
        }
        
        // Load backup info when switching to backup tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName, event) {
            originalSwitchTab(tabName, event);
            if (tabName === 'backup') {
                loadBackupInfo();
            }
        };
        
        // Auto-refresh for pending requests every 30 seconds
        setInterval(() => {
            const currentTab = document.querySelector('.tab-btn.active')?.textContent;
            if (currentTab === 'ุงูุฅุฌุงุฒุงุช') {
                loadPendingLeaves();
                console.log('๐ ุชุญุฏูุซ ุทูุจุงุช ุงูุฅุฌุงุฒุงุช');
            } else if (currentTab === 'ุงูุณูู') {
                loadPendingAdvances();
                console.log('๐ ุชุญุฏูุซ ุทูุจุงุช ุงูุณูู');
            }
        }, 30000);
    </script>
</body>
</html>
