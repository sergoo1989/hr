// HR Management System - schema.prisma
// يعكس متطلبات نظام الموارد البشرية السعودي

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id         Int       @id @default(autoincrement())
  username   String    @unique
  password   String
  role       String // 'EMPLOYEE' or 'ADMIN'
  employee   Employee? @relation(fields: [employeeId], references: [id])
  employeeId Int?      @unique
}

model Employee {
  id           Int     @id @default(autoincrement())
  employeeCode String? @unique // كود الموظف
  name         String
  nameEn       String? // الاسم بالإنجليزي
  nationalId   String  @unique
  email        String? @unique
  phone        String?

  // بيانات الإقامة والجواز
  iqamaNumber    String? // رقم الإقامة
  iqamaExpiry    DateTime? // تاريخ انتهاء الإقامة
  passportNumber String? // رقم الجواز
  passportExpiry DateTime? // تاريخ انتهاء الجواز
  nationality    String? // الجنسية

  // بيانات البنك
  bankName String? // اسم البنك
  iban     String? // رقم الآيبان

  // بيانات العمل
  workPermitNumber       String? // رقم رخصة العمل
  workPermitExpiry       DateTime? // تاريخ انتهاء رخصة العمل
  medicalInsuranceExpiry DateTime? // تاريخ انتهاء التأمين الطبي

  // التواريخ
  joinDate  DateTime? // تاريخ الالتحاق
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  contracts        Contract[]
  leaves           Leave[]
  travelTickets    TravelTicket[]
  advances         Advance[]
  assets           Asset[]
  attendances      Attendance[]
  entitlements     Entitlement[]
  documents        Document[]
  user             User?
  payrollItems     PayrollItem[]
  finalSettlements FinalSettlement[]
}

model Contract {
  id             Int       @id @default(autoincrement())
  employee       Employee  @relation(fields: [employeeId], references: [id])
  employeeId     Int
  startDate      DateTime
  endDate        DateTime?
  salary         Float
  leaveDays      Int // عدد أيام الإجازة السنوية (21 أو 30 حسب سنوات الخدمة)
  leaveMoney     Float // قيمة الإجازة المدفوعة
  contractType   String // 'FIXED' or 'UNLIMITED'
  probationDays  Int? // فترة التجربة بالأيام
  basicSalary    Float? // الراتب الأساسي
  housingAllow   Float? // بدل السكن
  transportAllow Float? // بدل النقل
}

model Leave {
  id             Int       @id @default(autoincrement())
  employee       Employee  @relation(fields: [employeeId], references: [id])
  employeeId     Int
  leaveType      String // 'ANNUAL', 'SICK', 'UNPAID', 'MATERNITY', 'PATERNITY', 'HAJJ'
  startDate      DateTime
  endDate        DateTime
  daysCount      Int
  paid           Boolean
  paidAmount     Float?
  status         String // 'PENDING', 'APPROVED', 'REJECTED'
  requestDate    DateTime  @default(now())
  approvedBy     Int?
  approvedAt     DateTime?
  rejectedReason String?
  sickPayRate    Float? // نسبة الدفع للإجازة المرضية (1.0, 0.75, 0)
}

model TravelTicket {
  id         Int       @id @default(autoincrement())
  employee   Employee  @relation(fields: [employeeId], references: [id])
  employeeId Int
  year       Int
  issued     Boolean   @default(false)
  issueDate  DateTime?
}

model Advance {
  id         Int      @id @default(autoincrement())
  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId Int
  amount     Float
  date       DateTime
  status     String // 'PENDING', 'APPROVED', 'REJECTED', 'PAID'
}

model Asset {
  id           Int       @id @default(autoincrement())
  employee     Employee  @relation(fields: [employeeId], references: [id])
  employeeId   Int
  assetType    String // 'LAPTOP', 'PHONE', ...
  description  String?
  assignedDate DateTime
  returned     Boolean   @default(false)
  returnDate   DateTime?
}

model Attendance {
  id         Int       @id @default(autoincrement())
  employee   Employee  @relation(fields: [employeeId], references: [id])
  employeeId Int
  date       DateTime
  checkIn    DateTime?
  checkOut   DateTime?
}

model Entitlement {
  id              Int       @id @default(autoincrement())
  yearsWorked     Float?
  fraction        Float? // 1.0 (full), 0.67 (2/3), 0.33 (1/3) للاستقالة
  terminationType String? // 'RESIGNATION', 'TERMINATION', 'CONTRACT_END'
  paid            Boolean   @default(false)
  paidDate        DateTime?
  employee        Employee  @relation(fields: [employeeId], references: [id])
  employeeId      Int
  type            String // 'END_OF_SERVICE', 'LEAVE_PAY', ...
  amount          Float
  calculatedAt    DateTime
}

model Document {
  id         Int      @id @default(autoincrement())
  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId Int
  docType    String // 'WORK_PERMIT', 'IQAMA', 'MEDICAL_INSURANCE', ...
  expiryDate DateTime
  number     String?
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  action     String // 'CREATE', 'UPDATE', 'DELETE', 'APPROVE', 'REJECT'
  entityType String // 'EMPLOYEE', 'LEAVE', 'ADVANCE', 'PAYROLL', etc
  entityId   Int
  before     String? // JSON snapshot قبل التغيير
  after      String? // JSON snapshot بعد التغيير
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
}

model PayrollRun {
  id              Int           @id @default(autoincrement())
  periodStart     DateTime
  periodEnd       DateTime
  status          String // 'DRAFT', 'PENDING_APPROVAL', 'APPROVED', 'LOCKED', 'PAID'
  createdBy       Int
  createdAt       DateTime      @default(now())
  approvedBy      Int?
  approvedAt      DateTime?
  lockedAt        DateTime?
  totalGross      Float?
  totalNet        Float?
  totalDeductions Float?
  items           PayrollItem[]
}

model PayrollItem {
  id                   Int        @id @default(autoincrement())
  payrollRun           PayrollRun @relation(fields: [payrollRunId], references: [id])
  payrollRunId         Int
  employee             Employee   @relation(fields: [employeeId], references: [id])
  employeeId           Int
  basicSalary          Float
  housingAllow         Float?
  transportAllow       Float?
  otherAllow           Float?
  overtimePay          Float?
  grossPay             Float
  advanceDeduction     Float?
  loanDeduction        Float?
  unpaidLeaveDeduction Float?
  otherDeductions      Float?
  totalDeductions      Float
  netPay               Float
  iban                 String?
  wpsStatus            String? // 'PENDING', 'GENERATED', 'UPLOADED'
}

model FinalSettlement {
  id              Int       @id @default(autoincrement())
  employee        Employee  @relation(fields: [employeeId], references: [id])
  employeeId      Int
  terminationDate DateTime
  terminationType String // 'RESIGNATION', 'TERMINATION', 'CONTRACT_END'
  lastWorkingDay  DateTime
  yearsWorked     Float
  eosbAmount      Float
  unusedLeaveDays Int
  unusedLeavePay  Float
  otherDues       Float?
  totalSettlement Float
  status          String // 'PENDING', 'APPROVED', 'PAID'
  approvedBy      Int?
  approvedAt      DateTime?
  paidDate        DateTime?
}
